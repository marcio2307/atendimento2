<!DOCTYPE html> 
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Chat + Tarot (tempo real)</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{ --vh:1vh; --safe-bottom:env(safe-area-inset-bottom,0px); --safe-top:env(safe-area-inset-top,0px); }
    *{box-sizing:border-box}
    body{ font-family:Arial, sans-serif; background:#1d1f21; margin:0; padding:0; color:#111; }

    /* ====== FILA ====== */
    .fila-container{ max-width:500px; margin:16px auto 8px; background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); border-radius:14px; padding:12px; box-shadow:0 6px 20px rgba(0,0,0,.25); display:flex; align-items:center; gap:12px; justify-content:space-between; color:#e5e7eb; border:1px solid #2a2f36; }
    .fila-info{ display:flex; align-items:center; gap:10px; }
    .bolinha{ width:10px; height:10px; border-radius:50%; background:#00c800; animation:piscar 1s infinite; }
    .chip{ display:flex; align-items:center; justify-content:center; min-width:36px; height:28px; background:#111827; padding:0 10px; border-radius:20px; color:#e5e7eb; font-size:14px; font-weight:700; border:1px solid #374151;}
    .fila-actions{ display:flex; gap:10px;}
    .btn-proximo,.btn-timer{ display:inline-flex; align-items:center; gap:8px; background:#016e35; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-size:14px; font-weight:700; box-shadow:0 6px 14px rgba(1,110,53,.28); transition:transform .06s, box-shadow .2s, background .2s; }
    .btn-proximo:hover,.btn-timer:hover{ transform:translateY(-1px); box-shadow:0 10px 18px rgba(1,110,53,.33); }
    .btn-timer.stop{ background:#b91c1c; box-shadow:0 6px 14px rgba(185,28,28,.28); }
    .btn-timer .dot{ width:8px; height:8px; border-radius:50%; background:#fff; box-shadow:0 0 0 0 rgba(255,255,255,.6); }
    .btn-timer.stop .dot{ animation:pulseDot 1.2s infinite; }
    @keyframes pulseDot{0%{box-shadow:0 0 0 0 rgba(255,255,255,.5)}70%{box-shadow:0 0 0 8px rgba(255,255,255,0)}100%{box-shadow:0 0 0 0 rgba(255,255,255,0)}}
    body[data-role="cliente"] .fila-container{ display:none!important; }

    /* ====== CHAT ====== */
    .chat-container{ width:100%; max-width:500px; height:calc(var(--vh)*100); margin:0 auto 12px; background:#f7f7f7; border-radius:12px; box-shadow:0 0 15px rgba(0,0,0,.25); display:flex; flex-direction:column; overflow:hidden; position:relative; }

    .chat-header{ position:sticky; top:0; z-index:2; display:flex; align-items:center; gap:10px; background:#fff; padding:12px 12px calc(12px + var(--safe-top)); color:#0f172a; border-bottom:1px solid #e5e7eb; box-shadow:0 1px 3px rgba(0,0,0,.08); }
    .chat-header strong{ font-size:16px; }
    .timer{ font-size:14px; margin-left:auto; color:#0f172a; display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:rgba(15,23,42,.06); border:1px solid rgba(15,23,42,.12); box-shadow:inset 0 0 6px rgba(0,0,0,.04); }
    .timer.running{ animation:pulseTimer 2s ease-in-out infinite; }
    .btn-som{ margin-left:8px; background:#e5e7eb; color:#0f172a; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:14px; }
    .btn-som.off{ background:#d1d5db; color:#111827; }

    .chat-header .avatar{ width:56px; height:56px; border-radius:50%; border:2px solid #fff; box-shadow:0 1px 2px rgba(0,0,0,.15); object-fit:cover; background:#e5e7eb; flex:0 0 auto; cursor:pointer; transition:box-shadow .2s; }
    .chat-header .avatar.online{ box-shadow:0 0 0 3px #22c55e,0 0 0 6px #fff,0 2px 4px rgba(0,0,0,.18); }

    .chat-body{ flex:1; overflow-y:auto; overflow-x:hidden; padding:10px 12px 16px; background-color:#eae6df; background-image:url("imagem/papel-tarot.png"); background-repeat:repeat; background-size:520px auto; background-attachment:fixed; background-position:center; display:flex; flex-direction:column; gap:10px; overscroll-behavior:contain; -webkit-overflow-scrolling:touch; }
    .center-row{ margin:auto; display:none; justify-content:center; align-items:center; width:100%; }

    .message{ margin:2px 0; display:flex; align-items:flex-end; }
    .message.attendant{ justify-content:flex-end; }
    .message.client{ justify-content:flex-start; }

    .message .bubble{ position:relative; padding:10px 12px; border-radius:12px; max-width:82%; line-height:1.35; box-shadow:0 1px 0 rgba(0,0,0,.06); display:inline-block; word-wrap:break-word; overflow-wrap:anywhere; transition:transform .18s, box-shadow .18s; will-change:transform; touch-action:pan-y; -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; }
    .message.attendant .bubble{ background:#d9fdd3; color:#111; border-bottom-right-radius:4px; }
    .message.client .bubble{ background:#fff; color:#222; border-bottom-left-radius:4px; }

    .message.mine{ justify-content:flex-end!important; }
    .message.theirs{ justify-content:flex-start!important; }
    .message.mine .bubble{ background:#d9fdd3; color:#111; border-bottom-right-radius:4px; border-bottom-left-radius:12px; margin-left:auto; margin-right:4px; }
    .message.theirs .bubble{ background:#fff; color:#222; border-bottom-left-radius:4px; border-bottom-right-radius:12px; margin-right:auto; margin-left:4px; }
    .bubble.dragging{ box-shadow:0 6px 18px rgba(0,0,0,.15); }

    .trash-pop{ position:absolute; top:-10px; right:-10px; z-index:3; border:none; border-radius:999px; width:36px; height:36px; display:grid; place-items:center; background:#ef4444; color:#fff; cursor:pointer; box-shadow:0 8px 20px rgba(239,68,68,.35); transform:scale(.9); opacity:0; pointer-events:none; transition:transform .16s, opacity .16s; }
    .bubble.show-trash .trash-pop{ opacity:1; pointer-events:auto; transform:scale(1); }

    .bubble::before{ content:''; position:absolute; left:-14px; top:50%; width:8px; height:8px; border-top:2px solid rgba(0,0,0,.15); border-left:2px solid rgba(0,0,0,.15); transform:translateY(-50%) rotate(-45deg); opacity:0; transition:opacity .15s; }
    .bubble.swipe-hint::before{ opacity:1; }

    .message .text{ margin:0; padding:0; background:transparent; white-space:pre-wrap; }
    .message .image{ margin:0; padding:0; background:transparent; }
    .message .image img,.message .image canvas{ display:block; width:100%; height:auto; border-radius:8px; }

    .message .audio-wrap{ margin:0; padding:0; background:transparent; display:flex; gap:8px; align-items:center; justify-content:flex-end; max-width:100%; }
    .message .audio-wrap audio{ width:240px; max-width:100%; accent-color: #475569; }

    .reply-quote{ font-size:12px; opacity:.85; padding:6px 8px; border-left:3px solid #7c3aed; border-radius:8px; background:rgba(124,58,237,.06); margin-bottom:6px; max-width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .audio-toolbar{ display:inline-flex; gap:6px; align-items:center; }
    .rewind-btn{ border:none; background:rgba(0,0,0,.06); padding:6px 8px; border-radius:8px; cursor:pointer; font-size:14px; }
    .rewind-btn:hover{ filter:brightness(.95); }
    .message .audio-wrap .duration{ font-size:11px; opacity:.7; }

    /* ===== Digitando estilo WhatsApp ===== */
    .typing{ display:none; padding:0 12px; }
    .typing .typing-bubble{
      display:inline-flex; align-items:center; gap:6px;
      background:#fff; color:#444; border-radius:12px; padding:8px 10px;
      box-shadow:0 1px 0 rgba(0,0,0,.06); max-width:60%;
    }
    .typing .dots{ display:inline-flex; gap:4px; }
    .typing .dot{
      width:6px; height:6px; border-radius:50%; background:#9ca3af;
      animation:typingBounce 1.2s infinite ease-in-out;
    }
    .typing .dot:nth-child(2){ animation-delay:.2s; }
    .typing .dot:nth-child(3){ animation-delay:.4s; }
    .typing .typing-text{ font-size:12px; color:#6b7280; margin-left:6px; }
    @keyframes typingBounce{0%,80%,100%{transform:scale(.7);opacity:.65}40%{transform:scale(1);opacity:1}}

    .meta{ font-size:11px; color:#1d78f0; margin-top:4px; display:flex; align-items:center; gap:6px; }
    .receipt{ display:inline-flex; gap:2px; line-height:1; user-select:none; }
    .receipt .check{ font-weight:900; opacity:.65; }
    .receipt.seen .check{ color:#1d9bf0; opacity:1; }

    .chat-footer{ position:sticky; bottom:0; z-index:2; display:grid!important; grid-template-columns:42px 1fr 56px; align-items:center; gap:8px; border-top:1px solid #ddd; background:#f7f7f7; padding:8px 8px calc(8px + var(--safe-bottom)); }

    .reply-bar{ grid-column:1 / -1; display:none; align-items:center; gap:10px; background:#fff; border:1px dashed #c4b5fd; border-radius:10px; padding:6px 10px; margin:6px 0 2px; }
    .reply-bar .excerpt{ flex:1; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .reply-cancel{ background:transparent; border:none; font-size:18px; cursor:pointer; }

    .chat-footer input[type="text"]{ flex:1; padding:12px; border:none; outline:none; font-size:15px; border-radius:8px; background:#fff; }
    .chat-footer button{ background:#016e35; border:none; color:white; padding:10px 16px; cursor:pointer; font-size:14px; border-radius:8px; }
    .icon-btn{ width:42px; height:42px; border-radius:50%; display:grid; place-items:center; padding:0; }
    .icon-btn.secondary{ background:#e5e7eb; color:#111; }

    #endBtn{ background:#b91414; padding:10px 15px; border:none; color:white; margin:10px; border-radius:6px; cursor:pointer; width:calc(100% - 20px); }
    body[data-role="cliente"] #endBtn{ display:none!important; }
    #chat-ended{ text-align:center; padding:20px; color:#016e35; font-weight:bold; display:none; }

    @keyframes piscar{0%{opacity:1}50%{opacity:0}100%{opacity:1}}

    body[data-role="cliente"] #lenRootWrap, body[data-role="cliente"] .tarot-actions{ display:none!important; }
    #lenRoot{ --gap:26px; background:transparent; }
    .layout{display:block}
    .board{ padding:20px 14px 10px; display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:var(--gap); justify-items:center; }
    .slot{ display:grid; place-items:center; width:100%; }
    .card{ width:clamp(100px,28vw,140px); aspect-ratio:62/100; position:relative; border-radius:16px; transform-style:preserve-3d; transition:transform 220ms cubic-bezier(.25,.8,.2,1); cursor:pointer; background:none; border:none; margin:0; box-shadow:0 14px 24px rgba(0,0,0,.28), 0 2px 6px rgba(0,0,0,.25); outline:none; }
    .face{ position:absolute; inset:0; border-radius:16px; overflow:hidden; backface-visibility:hidden; border:none; }
    .front{ transform:rotateY(180deg); display:grid; place-items:center; position:relative; }
    .back{ display:grid; place-items:center; background:#0f2d55; }
    .card.flipped{ transform:rotateY(180deg); }
    #lenRootWrap{ max-width:500px; margin:8px auto; background:rgba(255,255,255,.06); border-radius:12px; }
    .tarot-actions{ max-width:500px; margin:8px auto 22px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }

    .waiting-banner{ background:#d32f2f; color:#fff; font-weight:700; text-align:center; padding:12px 14px; border-radius:10px; width:fit-content; max-width:92%; box-shadow:0 2px 8px rgba(0,0,0,.15); user-select:none; pointer-events:none; }

    .disabled{ opacity:.6; pointer-events:none; }
    @media (min-width:601px){ .chat-container{ border-radius:12px; } }

    body[data-role="cliente"] #roleTitle{ display:none!important; }
    body[data-role="atendente"] #roleTitle{ display:none!important; }

    @keyframes pulseTimer{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
    body[data-role="cliente"] .chat-header{ justify-content:center; }
    body[data-role="cliente"] .timer{ margin-left:0; font-size:22px; font-weight:800; letter-spacing:1px; padding:4px 12px; border-radius:999px; border:2px solid rgba(15,23,42,.12); background:rgba(15,23,42,.06); box-shadow:0 0 12px rgba(0,0,0,.08), inset 0 0 6px rgba(0,0,0,.04); animation:pulseTimer 2s ease-in-out infinite; }

    @keyframes ring{0%{transform:rotate(0)}5%{transform:rotate(18deg)}10%{transform:rotate(-14deg)}15%{transform:rotate(10deg)}20%{transform:rotate(-6deg)}25%{transform:rotate(4deg)}30%{transform:0}100%{transform:0}}
    body[data-role="cliente"] .btn-som{ transform-origin:top center; animation:ring 1.4s ease-in-out infinite; }

    body[data-role="cliente"] .message.client{ justify-content:flex-end; }
    body[data-role="cliente"] .message.attendant{ justify-content:flex-start; }
    body[data-role="cliente"] .message.client .bubble{ background:#d9fdd3; color:#111; border-bottom-right-radius:4px; border-bottom-left-radius:12px; }
    body[data-role="cliente"] .message.attendant .bubble{ background:#fff; color:#222; border-bottom-left-radius:4px; border-bottom-right-radius:12px; }
    @media (max-width:360px){ .message .bubble{ max-width:88%; } }

    .only-client{ display:inline-flex; }

    /* ======= FAB WhatsApp + Barra de Gravação ======= */
    :root{
      --wa-green:#25D366;
      --wa-green-dark:#1dae57;
      --wa-danger:#ed4245;
      --wa-muted:#9aa0a6;
    }
    #actionBtn{
      width:56px;height:56px;border-radius:50%;
      display:grid;place-items:center;font-size:0;border:none;cursor:pointer;
      background:var(--wa-green);
      box-shadow:0 8px 16px rgba(37,211,102,.35);
      transition:transform .06s, box-shadow .2s, background .2s;
    }
    #actionBtn:hover{ transform:translateY(-1px); box-shadow:0 10px 18px rgba(37,211,102,.4); }
    #actionBtn .ico{ width:26px;height:26px; display:block; background-repeat:no-repeat; background-position:center; background-size:26px 26px; }
    #actionBtn.mic .ico{
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23fff"><path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V21h2v-3.08A7 7 0 0 0 19 11h-2Z"/></svg>');
    }
    #actionBtn.send .ico{
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23fff"><path d="M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"/></svg>');
    }

    .rec-bar{
      grid-column:1 / -1;
      display:none; align-items:center; gap:12px;
      background:#fff; border:1px solid #e5e7eb; border-radius:12px;
      padding:8px 10px; margin:4px 0 0;
    }
    .rec-bar.show{ display:flex; }
    .rec-label{
      font-weight:700;color:#111;background:#eef2ff;border:1px solid #c7d2fe;
      padding:6px 10px;border-radius:999px;
      /* NEW: oculto para você durante a gravação */
      display:none;
    }
    .rec-time{ font-weight:700; min-width:42px; }
    .rec-meter{ flex:1; display:flex; align-items:center; gap:6px; }
    .rec-meter .dot{ width:6px;height:6px;border-radius:50%; background:#9ca3af; transform-origin:center bottom; opacity:.8; }
    .rec-btn{ border:none; background:#f3f4f6; color:#111; border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:700; }
    .rec-btn.pause{ background:var(--wa-danger); color:#fff; }
    .rec-btn.trash{ background:#eceff1; color:#444; }
    .rec-btn .i{ width:18px;height:18px; display:inline-block; vertical-align:-4px; background-repeat:no-repeat;background-size:18px 18px;background-position:center; margin-right:6px;}
    .i-pause{ background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" fill="%23fff" viewBox="0 0 24 24"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>'); }
    .i-trash{ background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" fill=\"%23444\" viewBox=\"0 0 24 24\"><path d=\"M6 7h12l-1 13H7L6 7zm3-3h6l1 2H8l1-2z\"/></svg>'); }

    /* NEW: badge de gravação visível a ambos */
    .rec-badge{
      display:none; align-items:center; gap:8px; margin-left:8px;
      padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700;
      color:#b91c1c; background:#fee2e2; border:1px solid #fecaca;
    }
    .rec-badge .dot{ width:8px;height:8px;border-radius:50%; background:#ef4444; box-shadow:0 0 0 0 rgba(239,68,68,.5); animation:pulseDot 1.2s infinite; }
    .rec-badge.show{ display:inline-flex; }

    /* === NOVO: estilo quando o áudio do REMETENTE foi escutado === */
    .message.mine .bubble.audio-heard{ background:#cfe8ff!important; }
    .meta .heard-flag{ font-size:11px; color:#1d9bf0; font-weight:700; }

    /* === Picker de reações estilo WhatsApp === */
    .react-picker{
      position: fixed;
      z-index: 9999;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      box-shadow: 0 8px 24px rgba(0,0,0,.18);
      user-select: none;
      -webkit-user-select: none;
      animation: rpPop .12s ease-out;
    }
    .react-picker button{
      border: none;
      background: transparent;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      padding: 6px 8px;
      border-radius: 999px;
    }
    .react-picker button:hover{ background:#f3f4f6; }
    .react-picker .reply-opt{
      font-size: 14px;
      padding: 6px 10px;
      color:#111;
      border:1px solid #e5e7eb;
      background:#f9fafb;
    }
    @keyframes rpPop{ from{ transform: scale(.92); opacity:.0 } to{ transform: scale(1); opacity:1 } }

    /* === Linha de reações embaixo do balão === */
    .reactions-row{
      display: inline-flex;
      gap: 6px;
      margin-top: 6px;
    }
    .reaction-pill{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      background:#fff;
      border:1px solid #e5e7eb;
      box-shadow:0 1px 0 rgba(0,0,0,.06);
    }
    .message.mine .reaction-pill{ background:#e8f3ff; border-color:#dbeafe; }

    /* === Indicador de gravação do OUTRO (estilo WhatsApp, canto inferior esquerdo) === */
    .mic-indicator{
      position:absolute;
      left:12px;
      bottom:calc(12px + var(--safe-bottom));
      width:36px; height:36px;
      border-radius:12px;
      display:none; place-items:center;
      background:#111827;
      pointer-events:none;
      box-shadow:0 2px 8px rgba(0,0,0,.18);
    }
    .mic-indicator.show{ display:grid; }
    .mic-indicator::before{
      content:'';
      position:absolute; inset:-3px;
      border-radius:14px;
      box-shadow:0 0 0 0 rgba(37,211,102,.55);
      animation:micPulse 1.4s ease-out infinite;
    }
    .mic-indicator .ico{
      width:18px; height:18px; display:block;
      background-repeat:no-repeat; background-position:center; background-size:18px 18px;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ffffff"><path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V21h2v-3.08A7 7 0 0 0 19 11h-2Z"/></svg>');
    }
    @keyframes micPulse{
      0%{ box-shadow:0 0 0 0 rgba(37,211,102,.55) }
      70%{ box-shadow:0 0 0 12px rgba(37,211,102,0) }
      100%{ box-shadow:0 0 0 0 rgba(37,211,102,0) }
    }
  </style>
</head>
<body data-role="">

 <!-- Fila -->
<div class="fila-container">
  <div class="fila-info">
    <div class="bolinha" aria-hidden="true"></div>
    <div>Clientes em espera:</div>
    <div class="chip" id="chipEspera">0</div>
  </div>
  <div class="fila-actions">
    <button class="btn-proximo" id="btnProximo">⏭️ Próximo da fila</button>
    <button class="btn-timer" id="btnTimer"><span class="dot"></span> Iniciar tempo</button>
  </div>
</div>

<!-- ===== Chat ===== -->
<div class="chat-container" id="chatBox">
  <div class="chat-header">
    <img id="avatarImg" class="avatar" alt="Foto do atendente" title="Trocar foto" />
    <strong id="roleTitle">Atendimento</strong>
    <div class="timer" id="timer">⏱️ 00:00</div>
    <!-- NEW: indicador de gravação (aparece para ambos) -->
    <span id="recBadge" class="rec-badge" aria-live="polite"><span class="dot" aria-hidden="true"></span> gravando…</span>
    <button id="toggleSound" class="btn-som" title="Ativar/desativar som">🔔</button>
  </div>

  <div class="chat-body" id="chatBody">
    <div class="center-row" id="centerRow">
      <div class="waiting-banner" id="waitingBanner">Consultor em atendimento, aguarde ser chamado...</div>
    </div>
  </div>

  <!-- Digitando estilo WhatsApp -->
  <div class="typing" id="typingHint" style="display:none">
    <span class="typing-bubble">
      <span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>
      <span class="typing-text">digitando…</span>
    </span>
  </div>

  <!-- Barra de resposta -->
  <div class="reply-bar" id="replyBar">
    <div>↩️</div>
    <div class="excerpt" id="replyExcerpt"></div>
    <button class="reply-cancel" id="replyCancel" title="Cancelar resposta">✖</button>
  </div>

  <div class="chat-footer">
    <button id="fileBtn" class="icon-btn secondary" title="Enviar foto/arquivo">📎</button>
    <input type="file" id="fileInput" accept="image/*" hidden />
    <input type="file" id="avatarPicker" accept="image/*" hidden />
    <input type="text" id="msgInput" placeholder="Digite sua mensagem..." />

    <!-- FAB WhatsApp -->
    <button id="actionBtn" class="mic" title="Gravar áudio"><span class="ico" aria-hidden="true"></span></button>

    <!-- Indicador de que o OUTRO está gravando (não clicável) -->
    <div id="remoteRecIndicator" class="mic-indicator" aria-live="polite" aria-label="Gravando áudio">
      <span class="ico" aria-hidden="true"></span>
    </div>

    <!-- Barra de gravação estilo WhatsApp (sem botão Enviar) -->
    <div id="recBar" class="rec-bar" aria-live="polite">
      <button id="recTrash" class="rec-btn trash" title="Apagar">
        <span class="i i-trash" aria-hidden="true"></span>Apagar
      </button>

      <div class="rec-label" id="recLabel">🎙️ Gravando áudio</div> <!-- fica oculto localmente -->

      <div class="rec-time" id="recTime">0:00</div>

      <div class="rec-meter" id="recMeter" aria-hidden="true">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        <span class="dot"></span><span class="dot"></span>
      </div>

      <button id="recPause" class="rec-btn pause" title="Pausar/Retomar">
        <span class="i i-pause" aria-hidden="true"></span>Pausar
      </button>
    </div>
  </div>

  <button id="endBtn">Encerrar conversa</button>
</div>

<div id="chat-ended">✅ Conversa encerrada</div>

<!-- ===== Tarot ===== -->
<div id="lenRootWrap">
  <div id="lenRoot">
    <div class="layout">
      <main class="board" id="board" aria-label="Mesa de cartas"></main>
    </div>
  </div>
</div>
<div class="tarot-actions">
  <button class="btn-print" id="btnTarotPrint" aria-label="Enviar print das cartas">Enviar print das cartas</button>
  <button class="btn-shuffle" id="btnTarotShuffle" aria-label="Embaralhar cartas">Embaralhar cartas</button>
</div>

<!-- Áudio -->
<audio id="sndSend" preload="auto" src="/sounds/notify.mp3"></audio>
<audio id="sndRecv" preload="auto" src="/sounds/notify.mp3"></audio>
<audio id="sndQueue" preload="auto" src="/sounds/bell.mp3"></audio>

<!-- libs -->
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* ===== Ajuste 100vh móvel ===== */
function setVh(){ const vh = window.innerHeight * 0.01; document.documentElement.style.setProperty('--vh', `${vh}px`); }
setVh(); addEventListener('resize', setVh); addEventListener('orientationchange', setVh);

/* ===== IDENTIDADE POR ABA ===== */
const qs = new URLSearchParams(location.search);
const ROLE = (qs.get("role") || "cliente").toLowerCase();
const ROOM = (qs.get("room") || "main");
function genUID(){ if (crypto && crypto.randomUUID) return crypto.randomUUID(); return Date.now()+"-"+Math.random().toString(36).slice(2); }
if (!sessionStorage.getItem("UID")) sessionStorage.setItem("UID", genUID());
const UID = sessionStorage.getItem("UID");
document.body.setAttribute("data-role", ROLE);

/* ===== Título ===== */
const rtEl = document.getElementById("roleTitle");
if (ROLE === "atendente"){ rtEl.textContent = ""; } else { rtEl.textContent = `Atendimento (Cliente) — sala: ${ROOM}`; }

/* ===== AVATAR ===== */
const DEFAULT_AVATAR = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 96 96"><circle cx="48" cy="32" r="16" fill="%23cccccc"/><rect x="16" y="56" width="64" height="28" rx="14" fill="%23cccccc"/></svg>';
const AVATAR_KEY = `avatar:${ROOM}`;
const REMOTE_AVATAR_KEY = `remoteAvatar:${ROOM}`;
const avatarImg = document.getElementById('avatarImg');
const avatarPicker = document.getElementById('avatarPicker');

function setLocalAvatar(dataUrl){ try{ sessionStorage.setItem(AVATAR_KEY, dataUrl); }catch(_){} avatarImg.src = dataUrl; }
function setRemoteAvatar(dataUrl){ try{ sessionStorage.setItem(REMOTE_AVATAR_KEY, dataUrl); }catch(_){} avatarImg.src = dataUrl; }
function initAvatar(){
  avatarImg.src = DEFAULT_AVATAR;
  if (ROLE === 'atendente'){
    const saved = sessionStorage.getItem(AVATAR_KEY);
    if (saved) avatarImg.src = saved;
    avatarImg.addEventListener('click', ()=> avatarPicker.click());
    avatarPicker.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      if (!f.type.startsWith('image/')) return;
      const reader = new FileReader();
      reader.onload = async ()=>{
        const dataUrl = await downscaleDataUrl(reader.result, 256);
        setLocalAvatar(dataUrl);
        if (isPaired) { try { socket.emit("chat_image", { dataUrl, alt: "__avatar__" }); } catch(_){} }
        avatarPicker.value = '';
      };
      reader.readAsDataURL(f);
    });
  } else {
    const remote = sessionStorage.getItem(REMOTE_AVATAR_KEY);
    if (remote) avatarImg.src = remote;
  }
}

/* ===== HISTÓRICO LOCAL ===== */
const STORE_KEY = `history:${ROOM}:${ROLE}:${UID}`;
let history = []; let restored = false;
function saveHistory(){ try{ sessionStorage.setItem(STORE_KEY, JSON.stringify(history.slice(-200))); }catch(_){} }
function restoreHistory(){
  try { history = JSON.parse(sessionStorage.getItem(STORE_KEY) || "[]"); } catch{ history = []; }
  history.forEach(h=>{
    if (h.t==="text") addMessage(h.text, h.sender, h.id, h.seen, h.reply || null);
    if (h.t==="img") addImageMessage(h.dataUrl, h.sender, h.alt||"Imagem", h.id, h.seen, h.reply || null);
    if (h.t==="aud") addAudioMessage(h.dataUrl, h.sender, h.dur||0, h.id, h.seen, h.reply || null);
  });
  restored = true;
}

/* ===== DOM ===== */
const chatBody = document.getElementById('chatBody');
const centerRow = document.getElementById('centerRow');
const waitingBanner = document.getElementById('waitingBanner');
const timerEl = document.getElementById('timer');
const msgInput = document.getElementById('msgInput');
const actionBtn = document.getElementById('actionBtn');
const recBadge = document.getElementById('recBadge'); // NEW
const remoteRecIndicator = document.getElementById('remoteRecIndicator'); // NEW
function setRemoteRecIndicator(on){ if(remoteRecIndicator){ remoteRecIndicator.classList.toggle('show', !!on); } } // NEW

let segundos = 0, cronometro = null, isPaired = false;

/* ===== Barra de gravação DOM ===== */
const recBar   = document.getElementById('recBar');
const recTime  = document.getElementById('recTime');
const recMeter = document.getElementById('recMeter');
const recPauseBtn = document.getElementById('recPause');
const recTrashBtn = document.getElementById('recTrash');
const recLabel = document.getElementById('recLabel');
let recUITimer = null;
let recAnalyser = null, recAudioCtx = null, recSrcNode = null;
let recPaused = false;

/* ===== REPLY ===== */
let replyContext = null;
const replyBar = document.getElementById('replyBar');
const replyExcerpt = document.getElementById('replyExcerpt');
const replyCancel = document.getElementById('replyCancel');
replyCancel.addEventListener('click', clearReply);
function setReply(ctx){ replyContext = ctx; replyExcerpt.textContent = ctx.preview || ''; replyBar.style.display = 'flex'; }
function clearReply(){ replyContext = null; replyBar.style.display = 'none'; replyExcerpt.textContent = ''; }

/* ===== Persistência local do timer ===== */
const TIMER_KEY = `timer:${ROOM}`;
function saveTimerLocal(state){ try{ localStorage.setItem(TIMER_KEY, JSON.stringify(state)); }catch(_){} }
function loadTimerLocal(){ try{ return JSON.parse(localStorage.getItem(TIMER_KEY) || "{}"); }catch(_){ return {}; } }
function applyTimerLocalOnLoad(){ const st = loadTimerLocal(); if (Number.isFinite(st.pausedSec)){ segundos = Math.max(0, st.pausedSec|0); updateTimer(); } else { segundos = 0; updateTimer(); } }

/* ===== SOCKET ===== */
const socket = io({ transports: ["websocket", "polling"] });

socket.on("connect", () => {
  socket.emit("register", { role: ROLE, room: ROOM, name: ROLE === "cliente" ? "Cliente" : "Atendente", uid: UID });

  initAvatar();

  if (ROLE === "cliente") { centerRow.style.display = "flex"; setChatEnabled(false); }
  if (!restored) restoreHistory();

  applyTimerLocalOnLoad();

  requestAnimationFrame(scrollDown);
  updateActionBtnState();
});

socket.on("queue_size", ({ size }) => { const chip = document.getElementById("chipEspera"); if (chip) chip.textContent = String(size); });
socket.on("queue_join", () => { if (ROLE === "atendente") playSound("sndQueue"); });

socket.on("paired", () => {
  isPaired = true;
  avatarImg.classList.add('online');
  timerEl.classList.toggle('running', !!cronometro);
  centerRow.style.display = "none";
  setChatEnabled(true);
  if (ROLE === "cliente" && history.length === 0) {
    addMessage("Conectado ao atendente.", "client", genUID(), true);
    history.push({ t:"text", sender:"client", text:"Conectado ao atendente.", id: genUID(), seen: true }); saveHistory();
  }
  if (ROLE === 'atendente'){
    const av = sessionStorage.getItem(AVATAR_KEY);
    if (av) { try { socket.emit("chat_image", { dataUrl: av, alt: "__avatar__" }); } catch(_){} }
  }
  scrollDown(); updateActionBtnState();
});

/* ===== Exclusão ===== */
function addDeleteButton(container, id){
  if (!id) return;
  const btn = document.createElement('button');
  btn.className = 'del-btn'; btn.title = 'Apagar mensagem'; btn.textContent = '🗑️';
  btn.style.cssText = 'margin-left:6px;background:transparent;border:none;cursor:pointer;opacity:.7;';
  btn.addEventListener('click', ()=>{ removeMessageDom(id); removeFromHistory(id); try{ socket.emit("delete_message", { id }); }catch(_){ } });
  return btn;
}
function removeMessageDom(id){ const el = chatBody.querySelector(`.message[data-id="${id}"]`); if (el) el.remove(); }
function removeFromHistory(id){ const idx = history.findIndex(h => h.id === id); if (idx >= 0){ history.splice(idx,1); saveHistory(); } }

/* ===== REAÇÕES ===== */
const REACT_KEY = `reactions:${ROOM}`;
let reactionsMap = {};
function loadReactions(){ try { reactionsMap = JSON.parse(sessionStorage.getItem(REACT_KEY) || "{}"); } catch { reactionsMap = {}; } }
function saveReactions(){ try { sessionStorage.setItem(REACT_KEY, JSON.stringify(reactionsMap)); } catch {} }
loadReactions();

const EMOJIS = ["👍","❤️","😂","😮","😢","🙏"];

/* ... (restante das funções de reação/long-press permanecem iguais) ... */

/* ====== MENSAGENS ====== */
const mySide = (ROLE === "atendente") ? "attendant" : "client";
const pendingReplyMeta = {}; // id -> preview (chega via fallback)

/* ... (funções addMessage/addImageMessage/addAudioMessage etc. permanecem iguais) ... */

/* ===== Digitando ===== */
const typingHint = document.getElementById("typingHint");
let typingHideTimer = null;

/* NOVO: estado do outro lado gravando? controla texto da bolha */
let otherRecActive = false;
const typingTextNode = document.querySelector('#typingHint .typing-text');

function setTypingText(txt){ if (typingTextNode) typingTextNode.textContent = txt; }

/* ... (handlers de typing existentes) ... */

/* ===== Timer / Encerrar ===== */
socket.on("timer_state", ({ running, elapsedSec }) => {
  if (shouldIgnoreInbound()) return;
  segundos = elapsedSec || 0;
  if (running){ saveTimerLocal({ running:true, startTs: Date.now() - (segundos*1000), pausedSec:0 }); iniciarCronometro(true); }
  else { pararCronometro(true); saveTimerLocal({ running:false, startTs:0, pausedSec:segundos }); }
  updateTimer();
});

socket.on("conversation_ended", ({ reason }) => {
  clearInterval(cronometro); cronometro = null; segundos = 0; updateTimer();
  timerEl.classList.remove('running'); avatarImg.classList.remove('online');
  try{ localStorage.removeItem(TIMER_KEY); }catch(_){}
  showEnded(reason); clearHistory(); chatBody.innerHTML = "";
  try { socket.emit("queue_sync", { room: ROOM }); } catch(_){ }
  setRecBadge(false);           // badge do header
  setRemoteRecIndicator(false); // <<< NOVO: some o mic do canto
  if (ROLE === "cliente") {
    const END_URL = "https://atendimento2.onrender.com/encerrado.html?v=" + Date.now();
    const box=document.createElement('div'); box.style.cssText="text-align:center;padding:12px;"; box.innerHTML=`🔁 Redirecionando para a avaliação…<br><a href="${END_URL}" style="font-weight:700;" target="_top" rel="noopener">Ir agora</a>`;
    document.body.appendChild(box);
    setTimeout(()=>{ try{ window.location.replace(END_URL);}catch(_){ window.location.href=END_URL; } }, 800);
  }
});

/* ===== Sons / envio / imagem ===== */
/* ... (todo o bloco já existente permanece igual) ... */

/* ===== Estado do FAB ===== */
function updateActionBtnState(){
  const hasText = msgInput.value.trim().length > 0;
  const btn = actionBtn;

  if (isRecording()){
    btn.classList.add('send');
    btn.classList.remove('mic');
    btn.title = 'Enviar áudio';
    return;
  }
  if (hasText){
    btn.classList.add('send'); btn.classList.remove('mic');
    btn.title='Enviar mensagem';
  }else{
    btn.classList.add('mic'); btn.classList.remove('send');
    btn.title='Gravar áudio';
  }
}

/* ===== ÁUDIO (toda sua lógica existente) ===== */
/* ... (mantida integralmente) ... */

/* ===== Clique do FAB ===== */
actionBtn.addEventListener('pointerdown', unlockAudioOnce, { once:true });
actionBtn.addEventListener('click', ()=>{
  if (ROLE === "cliente" && !isPaired) return;
  const hasText=msgInput.value.trim().length>0;
  if(isRecording()){ stopRecording(); return; }  // envia áudio
  if(hasText) sendMessage(); else startRecording();
});

/* ===== Rec badge recebido do outro lado ===== */
/* SUBSTITUÍDO: agora também controla o texto/visibilidade da bolha e o mic do canto */
socket.on("rec_state", ({ state, from })=>{
  if (shouldIgnoreInbound()) return;
  const isOther = ((from === "attendant" && ROLE === "cliente") || (from === "client" && ROLE === "atendente"));
  if (!isOther) return;

  if (state === "start" || state === "resume" || state === "pause"){
    otherRecActive = true;
    setRecBadge(true);
    setRemoteRecIndicator(true);      // NOVO
    setTypingText('gravando áudio…');
    showTypingBubble();
  } else {
    otherRecActive = false;
    setRecBadge(false);
    setRemoteRecIndicator(false);     // NOVO
    hideTypingBubble();
  }
});

/* NOVO: quando destinatário ouvir até o fim, o remetente pinta o balão */
socket.on('audio_listened', ({ id })=>{
  const msg = document.querySelector(`.message[data-id="${id}"]`);
  if (!msg || !msg.classList.contains('mine')) return; // só pinta no lado de quem enviou
  const bubble = msg.querySelector('.bubble');
  if (bubble) bubble.classList.add('audio-heard');
  const meta = msg.querySelector('.meta');
  if (meta && !meta.querySelector('.heard-flag')){
    const f = document.createElement('span'); f.className='heard-flag'; f.textContent='áudio escutado';
    meta.appendChild(f);
  }
});

/* ===== Controles do atendente ===== */
const btnProximo=document.getElementById("btnProximo");
const btnTimer=document.getElementById("btnTimer");
const endBtn=document.getElementById("endBtn");
if (ROLE !== "atendente"){ btnProximo.style.display="none"; btnTimer.style.display="none"; }
btnProximo.addEventListener("click", ()=> socket.emit("next_in_queue"));
btnTimer.addEventListener("click", ()=>{ if(cronometro){ pararCronometro(); btnTimer.innerHTML='<span class="dot"></span> Iniciar tempo'; btnTimer.classList.remove("stop"); } else { iniciarCronometro(); btnTimer.innerHTML='<span class="dot"></span> Parar tempo'; btnTimer.classList.add("stop"); } });
endBtn.addEventListener("click", ()=> socket.emit("end_conversation"));

/* ===== TAROT ===== */
const DECK=[{n:0,nome:"O Louco",img:'cards/o-louco.jpg'},{n:1,nome:"O Mago",img:'cards/o-mago.jpg'},{n:2,nome:"A Sacerdotisa",img:'cards/a-sacerdotisa.jpg'},{n:3,nome:"A Imperatriz",img:'cards/a-imperatriz.jpg'},{n:4,nome:"O Imperador",img:'cards/o-imperador.jpg'},{n:5,nome:"O Papa",img:'cards/o-papa.jpg'},{n:6,nome:"Os Enamorados",img:'cards/os-enamorados.jpg'},{n:7,nome:"O Carro",img:'cards/o-carro.jpg'},{n:8,nome:"A Força",img:'cards/a-forca.jpg'},{n:9,nome:"O Eremita",img:'cards/o-eremita.jpg'},{n:10,nome:"A Roda da Fortuna",img:'cards/a-roda-da-fortuna.jpg'},{n:11,nome:"A Justiça",img:'cards/a-justica.jpg'},{n:12,nome:"O Enforcado",img:'cards/o-enforcado.jpg'},{n:13,nome:"A Morte",img:'cards/a-morte.jpg'},{n:14,nome:"A Temperança",img:'cards/a-temperanca.jpg'},{n:15,nome:"O Diabo",img:'cards/o-diabo.jpg'},{n:16,nome:"A Torre",img:'cards/a-torre.jpg'},{n:17,nome:"A Estrela",img:'cards/a-estrela.jpg'},{n:18,nome:"A Lua",img:'cards/a-lua.jpg'},{n:19,nome:"O Sol",img:'cards/o-sol.jpg'},{n:20,nome:"O Julgamento",img:'cards/o-julgamento.jpg'},{n:21,nome:"O Mundo",img:'cards/o-mundo.jpg'}];
const board=document.getElementById("board"); let selecionadas=[];
function cryptoRandomInt(maxExclusive){ const c=window.crypto||window.msCrypto; if(!c) return Math.floor(Math.random()*maxExclusive); const a=new Uint32Array(1); c.getRandomValues(a); return a[0]%maxExclusive; }
function shuffleCrypto(arr){ for(let i=arr.length-1;i>0;i--){ const j=cryptoRandomInt(i+1); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
function sortear(n){ const idx=Array.from(DECK.keys()); shuffleCrypto(idx); return idx.slice(0,n); }
function montarCarta(deckIndex){
  const data=DECK[deckIndex];
  const slot=document.createElement("div"); slot.className="slot";
  const card=document.createElement("div"); card.className="card"; card.tabIndex=0;
  const back=document.createElement("div"); back.className="face back";
  const backImg=document.createElement("img"); backImg.src="cards/back.png"; backImg.alt="Verso"; backImg.decoding="async"; backImg.loading="eager"; backImg.style.width="100%"; backImg.style.height="100%"; backImg.style.objectFit="cover"; back.appendChild(backImg);
  const front=document.createElement("div"); front.className="face front";
  const img=document.createElement("img"); img.alt=data.nome; img.src=data.img; img.style.width="100%"; img.style.height="100%"; img.style.objectFit="cover"; front.appendChild(img);
  const flip=()=>{ card.classList.toggle("flipped"); };
  card.addEventListener("click", flip);
  card.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); flip(); } });
  card.appendChild(back); card.appendChild(front); slot.appendChild(card); return slot;
}
function renderBoard(){ board.innerHTML=""; selecionadas.forEach((i)=> board.appendChild(montarCarta(i))); }
(function initTarot(){ selecionadas=sortear(6); renderBoard(); })();

/* ===== PRINT ===== */
const TARGET_WIDTH=320;
async function downscaleDataUrl(dataUrl, targetW=TARGET_WIDTH){
  return new Promise((resolve)=>{ const img=new Image(); img.onload=()=>{ const ratio=Math.min(targetW/img.width,1); const canvas=document.createElement('canvas'); canvas.width=Math.round(img.width*ratio); canvas.height=Math.round(img.height*ratio); canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height); resolve(canvas.toDataURL('image/png')); }; img.src=dataUrl; });
}
document.getElementById("btnTarotPrint").addEventListener("click", async ()=>{
  const target=document.querySelector("#lenRoot");
  try{
    const canvas=await html2canvas(target,{ backgroundColor:null, scale:1 });
    const raw=canvas.toDataURL("image/png");
    const thumb=await downscaleDataUrl(raw, TARGET_WIDTH);
    const id=genUID();
    addImageMessage(thumb, ROLE==="atendente"?"attendant":"client", "Leitura de Tarot", id, false);
    history.push({ t:"img", sender: ROLE==="atendente"?"attendant":"client", dataUrl: thumb, alt:"Leitura de Tarot", id, seen:false }); saveHistory();
    socket.emit("chat_image", { dataUrl: thumb, alt:"Leitura de Tarot", id });
  }catch(err){
    console.error("Falha ao gerar print:", err);
    addMessage("Não foi possível gerar o print das cartas neste momento.", ROLE==="atendente"?"attendant":"client");
    history.push({ t:"text", sender: ROLE==="atendente"?"attendant":"client", text:"Não foi possível gerar o print das cartas neste momento." }); saveHistory();
  }
});
document.getElementById("btnTarotShuffle").addEventListener("click", ()=>{ selecionadas=sortear(6); renderBoard(); });

/* ===== Sair da fila ao fechar (cliente) ===== */
function notifyLeavingQueue(){
  try{
    if (ROLE === "cliente" && !isPaired) {
      socket.emit("leave_queue", { uid: UID, room: ROOM });
      socket.emit("queue_sync", { room: ROOM });
    }
  }catch(e){}
}
addEventListener("beforeunload", notifyLeavingQueue);
addEventListener("pagehide", notifyLeavingQueue);

function genUID(){ if (crypto && crypto.randomUUID) return crypto.randomUUID(); return Date.now()+"-"+Math.random().toString(36).slice(2); }
</script>
</body>
</html>

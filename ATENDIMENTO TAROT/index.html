<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Chat + Tarot (tempo real)</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{ --vh:1vh; --safe-bottom:env(safe-area-inset-bottom,0px); --safe-top:env(safe-area-inset-top,0px); --wa-green:#25D366; --wa-danger:#ed4245; }
    *{box-sizing:border-box}
    body{ font-family:Arial, sans-serif; background:#1d1f21; margin:0; padding:0; color:#111; }

    /* ====== FILA ====== */
    .fila-container{ max-width:500px; margin:16px auto 8px; background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); border-radius:14px; padding:12px; box-shadow:0 6px 20px rgba(0,0,0,.25); display:flex; align-items:center; gap:12px; justify-content:space-between; color:#e5e7eb; border:1px solid #2a2f36; }
    .fila-info{ display:flex; align-items:center; gap:10px; }
    .bolinha{ width:10px; height:10px; border-radius:50%; background:#00c800; animation:piscar 1s infinite; }
    .chip{ display:flex; align-items:center; justify-content:center; min-width:36px; height:28px; background:#111827; padding:0 10px; border-radius:20px; color:#e5e7eb; font-size:14px; font-weight:700; border:1px solid #374151;}
    .fila-actions{ display:flex; gap:10px;}
    .btn-proximo,.btn-timer{ display:inline-flex; align-items:center; gap:8px; background:#016e35; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-size:14px; font-weight:700; box-shadow:0 6px 14px rgba(1,110,53,.28); transition:transform .06s, box-shadow .2s, background .2s; }
    .btn-proximo:hover,.btn-timer:hover{ transform:translateY(-1px); box-shadow:0 10px 18px rgba(1,110,53,.33); }
    .btn-timer.stop{ background:#b91c1c; box-shadow:0 6px 14px rgba(185,28,28,.28); }
    .btn-timer .dot{ width:8px; height:8px; border-radius:50%; background:#fff; box-shadow:0 0 0 0 rgba(255,255,255,.6); }
    @keyframes pulseDot{0%{box-shadow:0 0 0 0 rgba(255,255,255,.5)}70%{box-shadow:0 0 0 8px rgba(255,255,255,0)}100%{box-shadow:0 0 0 0 rgba(255,255,255,0)}}
    body[data-role="cliente"] .fila-container{ display:none!important; }

    /* ====== CHAT ====== */
    .chat-container{ width:100%; max-width:500px; height:calc(var(--vh)*100); margin:0 auto 12px; background:#f7f7f7; border-radius:12px; box-shadow:0 0 15px rgba(0,0,0,.25); display:flex; flex-direction:column; overflow:hidden; position:relative; }

    .chat-header{ position:sticky; top:0; z-index:2; display:flex; align-items:center; gap:10px; background:#fff; padding:12px 12px calc(12px + var(--safe-top)); color:#0f172a; border-bottom:1px solid #e5e7eb; box-shadow:0 1px 3px rgba(0,0,0,.08); }
    .chat-header strong{ font-size:16px; }
    .timer{ font-size:14px; margin-left:auto; color:#0f172a; display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:rgba(15,23,42,.06); border:1px solid rgba(15,23,42,.12); box-shadow:inset 0 0 6px rgba(0,0,0,.04); }
    .timer.running{ animation:pulseTimer 2s ease-in-out infinite; }
    .btn-som{ margin-left:8px; background:#e5e7eb; color:#0f172a; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:14px; }
    .btn-som.off{ background:#d1d5db; color:#111827; }

    .chat-header .avatar{ width:56px; height:56px; border-radius:50%; border:2px solid #fff; box-shadow:0 1px 2px rgba(0,0,0,.15); object-fit:cover; background:#e5e7eb; flex:0 0 auto; cursor:pointer; transition:box-shadow .2s; }
    .chat-header .avatar.online{ box-shadow:0 0 0 3px #22c55e,0 0 0 6px #fff,0 2px 4px rgba(0,0,0,.18); }

    .chat-body{ flex:1; overflow-y:auto; overflow-x:hidden; padding:10px 12px 16px; background-color:#eae6df; background-image:url("imagem/papel-tarot.png"); background-repeat:repeat; background-size:520px auto; background-attachment:fixed; background-position:center; display:flex; flex-direction:column; gap:10px; overscroll-behavior:contain; -webkit-overflow-scrolling:touch; }
    .center-row{ margin:auto; display:none; justify-content:center; align-items:center; width:100%; }
    .waiting-banner{ background:#d32f2f; color:#fff; font-weight:700; text-align:center; padding:12px 14px; border-radius:10px; width:fit-content; max-width:92%; box-shadow:0 2px 8px rgba(0,0,0,.15); user-select:none; pointer-events:none; }

    .message{ margin:2px 0; display:flex; align-items:flex-end; }
    .message.attendant{ justify-content:flex-end; }
    .message.client{ justify-content:flex-start; }

    .message .bubble{ position:relative; padding:10px 12px; border-radius:12px; max-width:82%; line-height:1.35; box-shadow:0 1px 0 rgba(0,0,0,.06); display:inline-block; word-wrap:break-word; overflow-wrap:anywhere; transition:transform .18s, box-shadow .18s; will-change:transform; touch-action:pan-y; -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; }
    .message.attendant .bubble{ background:#d9fdd3; color:#111; border-bottom-right-radius:4px; }
    .message.client .bubble{ background:#fff; color:#222; border-bottom-left-radius:4px; }

    .message.mine{ justify-content:flex-end!important; }
    .message.theirs{ justify-content:flex-start!important; }
    .message.mine .bubble{ background:#d9fdd3; color:#111; border-bottom-right-radius:4px; border-bottom-left-radius:12px; margin-left:auto; margin-right:4px; }
    .message.theirs .bubble{ background:#fff; color:#222; border-bottom-left-radius:4px; border-bottom-right-radius:12px; margin-right:auto; margin-left:4px; }

    .trash-pop{ position:absolute; top:-10px; right:-10px; z-index:3; border:none; border-radius:999px; width:36px; height:36px; display:grid; place-items:center; background:#ef4444; color:#fff; cursor:pointer; box-shadow:0 8px 20px rgba(239,68,68,.35); transform:scale(.9); opacity:0; pointer-events:none; transition:transform .16s, opacity .16s; }
    .bubble.show-trash .trash-pop{ opacity:1; pointer-events:auto; transform:scale(1); }

    .message .text{ white-space:pre-wrap; }
    .message .image img,.message .image canvas{ display:block; width:100%; height:auto; border-radius:8px; }
    .message .audio-wrap{ display:flex; gap:8px; align-items:center; justify-content:flex-end; }
    .message .audio-wrap audio{ width:240px; max-width:100%; accent-color:#475569; }
    .reply-quote{ font-size:12px; opacity:.85; padding:6px 8px; border-left:3px solid #7c3aed; border-radius:8px; background:rgba(124,58,237,.06); margin-bottom:6px; max-width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Digitando (igual) */
    .typing{ display:none; padding:0 12px; }
    .typing .typing-bubble{ display:inline-flex; align-items:center; gap:6px; background:#fff; color:#444; border-radius:12px; padding:8px 10px; box-shadow:0 1px 0 rgba(0,0,0,.06); max-width:60%; }
    .typing .dot{ width:6px;height:6px;border-radius:50%; background:#9ca3af; animation:typingBounce 1.2s infinite ease-in-out; }
    .typing .dot:nth-child(2){ animation-delay:.2s; } .typing .dot:nth-child(3){ animation-delay:.4s; }
    .typing .typing-text{ font-size:12px; color:#6b7280; margin-left:6px; }
    @keyframes typingBounce{0%,80%,100%{transform:scale(.7);opacity:.65}40%{transform:scale(1);opacity:1}}

    /* NOVO: “gravando áudio…” só para o outro ver */
    .recording{ display:none; padding:0 12px; }
    .recording .rec-bubble{ display:inline-flex; align-items:center; gap:8px; background:#fff; color:#b91c1c; border-radius:12px; padding:8px 10px; box-shadow:0 1px 0 rgba(0,0,0,.06); font-weight:700; }
    .rec-mic{ width:16px;height:16px;border-radius:50%; background:#b91c1c; position:relative; }
    .rec-mic::after{ content:''; position:absolute; inset:-4px; border-radius:50%; border:2px solid rgba(185,28,28,.35); animation:recPulse 1.2s infinite; }
    @keyframes recPulse{0%{transform:scale(1);opacity:1}100%{transform:scale(1.5);opacity:0}}
    .recording .text{ font-size:12px; color:#b91c1c; }

    .meta{ font-size:11px; color:#1d78f0; margin-top:4px; display:flex; gap:6px; }
    .receipt .check{ font-weight:900; opacity:.65; }
    .receipt.seen .check{ color:#1d9bf0; opacity:1; }

    .chat-footer{ position:sticky; bottom:0; z-index:2; display:grid!important; grid-template-columns:42px 1fr 56px; align-items:center; gap:8px; border-top:1px solid #ddd; background:#f7f7f7; padding:8px 8px calc(8px + var(--safe-bottom)); }
    .reply-bar{ grid-column:1 / -1; display:none; align-items:center; gap:10px; background:#fff; border:1px dashed #c4b5fd; border-radius:10px; padding:6px 10px; margin:6px 0 2px; }
    .reply-bar .excerpt{ flex:1; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .reply-cancel{ background:transparent; border:none; font-size:18px; cursor:pointer; }

    .chat-footer input[type="text"]{ padding:12px; border:none; outline:none; font-size:15px; border-radius:8px; background:#fff; }
    .icon-btn{ width:42px;height:42px;border-radius:50%; display:grid; place-items:center; padding:0; }
    .icon-btn.secondary{ background:#e5e7eb; color:#111; }

    /* FAB WhatsApp */
    #actionBtn{ width:56px;height:56px;border-radius:50%; display:grid;place-items:center; font-size:0; border:none; cursor:pointer; background:var(--wa-green); box-shadow:0 8px 16px rgba(37,211,102,.35); transition:transform .06s, box-shadow .2s, background .2s; }
    #actionBtn:hover{ transform:translateY(-1px); box-shadow:0 10px 18px rgba(37,211,102,.4); }
    #actionBtn .ico{ width:26px;height:26px; display:block; background-repeat:no-repeat; background-position:center; background-size:26px 26px; }
    #actionBtn.mic .ico{ background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23fff"><path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V21h2v-3.08A7 7 0 0 0 19 11h-2Z"/></svg>'); }
    #actionBtn.send .ico{ background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23fff"><path d="M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"/></svg>'); }

    /* Barra de gravação local (sem label “gravando”) */
    .rec-bar{ grid-column:1 / -1; display:none; align-items:center; gap:12px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:8px 10px; margin:4px 0 0; }
    .rec-bar.show{ display:flex; }
    .rec-time{ font-weight:700; min-width:42px; }
    .rec-meter{ flex:1; display:flex; align-items:center; gap:6px; }
    .rec-meter .dot{ width:6px;height:6px;border-radius:50%; background:#9ca3af; transform-origin:center bottom; opacity:.8; }
    .rec-btn{ border:none; background:#f3f4f6; color:#111; border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:700; }
    .rec-btn.pause{ background:var(--wa-danger); color:#fff; }
    .rec-btn.trash{ background:#eceff1; color:#444; }

    #endBtn{ background:#b91414; padding:10px 15px; border:none; color:white; margin:10px; border-radius:6px; cursor:pointer; width:calc(100% - 20px); }
    body[data-role="cliente"] #endBtn{ display:none!important; }

    @keyframes piscar{0%{opacity:1}50%{opacity:0}100%{opacity:1}}
    @keyframes pulseTimer{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}

    /* layout cliente */
    body[data-role="cliente"] .chat-header{ justify-content:center; }
    body[data-role="cliente"] .timer{ margin-left:0; font-size:22px; font-weight:800; letter-spacing:1px; padding:4px 12px; border-radius:999px; border:2px solid rgba(15,23,42,.12); background:rgba(15,23,42,.06); box-shadow:0 0 12px rgba(0,0,0,.08), inset 0 0 6px rgba(0,0,0,.04); animation:pulseTimer 2s ease-in-out infinite; }
  </style>
</head>
<body data-role="">

<!-- Fila -->
<div class="fila-container">
  <div class="fila-info">
    <div class="bolinha" aria-hidden="true"></div>
    <div>Clientes em espera:</div>
    <div class="chip" id="chipEspera">0</div>
  </div>
  <div class="fila-actions">
    <button class="btn-proximo" id="btnProximo">⏭️ Próximo da fila</button>
    <button class="btn-timer" id="btnTimer"><span class="dot"></span> Iniciar tempo</button>
  </div>
</div>

<!-- ===== Chat ===== -->
<div class="chat-container" id="chatBox">
  <div class="chat-header">
    <img id="avatarImg" class="avatar" alt="Foto do atendente" title="Trocar foto" />
    <strong id="roleTitle">Atendimento</strong>
    <div class="timer" id="timer">⏱️ 00:00</div>
    <button id="toggleSound" class="btn-som" title="Ativar/desativar som">🔔</button>
  </div>

  <div class="chat-body" id="chatBody">
    <div class="center-row" id="centerRow">
      <div class="waiting-banner" id="waitingBanner">Consultor em atendimento, aguarde ser chamado...</div>
    </div>
  </div>

  <!-- “digitando…” -->
  <div class="typing" id="typingHint" style="display:none">
    <span class="typing-bubble">
      <span class="dot"></span><span class="dot"></span><span class="dot"></span>
      <span class="typing-text">digitando…</span>
    </span>
  </div>

  <!-- NOVO: “gravando áudio…” (só o outro vê) -->
  <div class="recording" id="recordingHint" style="display:none">
    <span class="rec-bubble"><span class="rec-mic" aria-hidden="true"></span><span class="text">gravando áudio…</span></span>
  </div>

  <!-- Barra de resposta -->
  <div class="reply-bar" id="replyBar">
    <div>↩️</div>
    <div class="excerpt" id="replyExcerpt"></div>
    <button class="reply-cancel" id="replyCancel" title="Cancelar resposta">✖</button>
  </div>

  <div class="chat-footer">
    <button id="fileBtn" class="icon-btn secondary" title="Enviar foto/arquivo">📎</button>
    <input type="file" id="fileInput" accept="image/*" hidden />
    <input type="file" id="avatarPicker" accept="image/*" hidden />
    <input type="text" id="msgInput" placeholder="Digite sua mensagem..." />
    <button id="actionBtn" class="mic" title="Gravar áudio"><span class="ico" aria-hidden="true"></span></button>

    <!-- Barra de gravação local -->
    <div id="recBar" class="rec-bar" aria-live="polite">
      <button id="recTrash" class="rec-btn trash" title="Apagar">🗑️ Apagar</button>
      <div class="rec-time" id="recTime">0:00</div>
      <div class="rec-meter" id="recMeter" aria-hidden="true">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        <span class="dot"></span><span class="dot"></span>
      </div>
      <button id="recPause" class="rec-btn pause" title="Pausar/Retomar">⏸️ Pausar</button>
    </div>
  </div>

  <button id="endBtn">Encerrar conversa</button>
</div>

<div id="chat-ended" style="display:none">✅ Conversa encerrada</div>

<!-- ===== Tarot ===== -->
<div id="lenRootWrap">
  <div id="lenRoot">
    <div class="layout">
      <main class="board" id="board" aria-label="Mesa de cartas"></main>
    </div>
  </div>
</div>
<div class="tarot-actions" style="max-width:500px;margin:8px auto 22px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
  <button class="btn-print" id="btnTarotPrint" aria-label="Enviar print das cartas">Enviar print das cartas</button>
  <button class="btn-shuffle" id="btnTarotShuffle" aria-label="Embaralhar cartas">Embaralhar cartas</button>
</div>

<!-- Áudio -->
<audio id="sndSend" preload="auto" src="/sounds/notify.mp3"></audio>
<audio id="sndRecv" preload="auto" src="/sounds/notify.mp3"></audio>
<audio id="sndQueue" preload="auto" src="/sounds/bell.mp3"></audio>

<!-- libs -->
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* ===== Ajuste 100vh móvel ===== */
function setVh(){ const vh = window.innerHeight * 0.01; document.documentElement.style.setProperty('--vh', `${vh}px`); }
setVh(); addEventListener('resize', setVh); addEventListener('orientationchange', setVh);

/* ===== IDENTIDADE POR ABA ===== */
const qs = new URLSearchParams(location.search);
const ROLE = (qs.get("role") || "cliente").toLowerCase();
const ROOM = (qs.get("room") || "main");
function genUID(){ if (crypto && crypto.randomUUID) return crypto.randomUUID(); return Date.now()+"-"+Math.random().toString(36).slice(2); }
if (!sessionStorage.getItem("UID")) sessionStorage.setItem("UID", genUID());
const UID = sessionStorage.getItem("UID");
document.body.setAttribute("data-role", ROLE);

/* ===== Título ===== */
const rtEl = document.getElementById("roleTitle");
if (ROLE === "atendente"){ rtEl.textContent = ""; } else { rtEl.textContent = `Atendimento (Cliente) — sala: ${ROOM}`; }

/* ===== AVATAR ===== */
const DEFAULT_AVATAR = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 96 96"><circle cx="48" cy="32" r="16" fill="%23cccccc"/><rect x="16" y="56" width="64" height="28" rx="14" fill="%23cccccc"/></svg>';
const AVATAR_KEY = `avatar:${ROOM}`;
const REMOTE_AVATAR_KEY = `remoteAvatar:${ROOM}`;
const avatarImg = document.getElementById('avatarImg');
const avatarPicker = document.getElementById('avatarPicker');

function setLocalAvatar(dataUrl){ try{ sessionStorage.setItem(AVATAR_KEY, dataUrl); }catch(_){} avatarImg.src = dataUrl; }
function setRemoteAvatar(dataUrl){ try{ sessionStorage.setItem(REMOTE_AVATAR_KEY, dataUrl); }catch(_){} avatarImg.src = dataUrl; }
function initAvatar(){
  avatarImg.src = DEFAULT_AVATAR;
  if (ROLE === 'atendente'){
    const saved = sessionStorage.getItem(AVATAR_KEY);
    if (saved) avatarImg.src = saved;
    avatarImg.addEventListener('click', ()=> avatarPicker.click());
    avatarPicker.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      if (!f.type.startsWith('image/')) return;
      const reader = new FileReader();
      reader.onload = async ()=>{
        const dataUrl = await downscaleDataUrl(reader.result, 256);
        setLocalAvatar(dataUrl);
        if (isPaired) { try { socket.emit("chat_image", { dataUrl, alt: "__avatar__" }); } catch(_){} }
        avatarPicker.value = '';
      };
      reader.readAsDataURL(f);
    });
  } else {
    const remote = sessionStorage.getItem(REMOTE_AVATAR_KEY);
    if (remote) avatarImg.src = remote;
  }
}

/* ===== HISTÓRICO LOCAL ===== */
const STORE_KEY = `history:${ROOM}:${ROLE}:${UID}`;
let history = []; let restored = false;
function saveHistory(){ try{ sessionStorage.setItem(STORE_KEY, JSON.stringify(history.slice(-200))); }catch(_){} }
function restoreHistory(){
  try { history = JSON.parse(sessionStorage.getItem(STORE_KEY) || "[]"); } catch{ history = []; }
  history.forEach(h=>{
    if (h.t==="text") addMessage(h.text, h.sender, h.id, h.seen, h.reply || null);
    if (h.t==="img") addImageMessage(h.dataUrl, h.sender, h.alt||"Imagem", h.id, h.seen, h.reply || null);
    if (h.t==="aud") addAudioMessage(h.dataUrl, h.sender, h.dur||0, h.id, h.seen, h.reply || null);
  });
  restored = true;
}

/* ===== DOM ===== */
const chatBody = document.getElementById('chatBody');
const centerRow = document.getElementById('centerRow');
const timerEl = document.getElementById('timer');
const msgInput = document.getElementById('msgInput');
const actionBtn = document.getElementById('actionBtn');
const recordingHint = document.getElementById('recordingHint');

let segundos = 0, cronometro = null, isPaired = false;

/* ===== Barra de gravação DOM ===== */
const recBar   = document.getElementById('recBar');
const recTime  = document.getElementById('recTime');
const recMeter = document.getElementById('recMeter');
const recPauseBtn = document.getElementById('recPause');
const recTrashBtn = document.getElementById('recTrash');
let recUITimer = null;
let recAnalyser = null, recAudioCtx = null, recSrcNode = null;
let recPaused = false;

/* ===== REPLY ===== */
let replyContext = null;
const replyBar = document.getElementById('replyBar');
const replyExcerpt = document.getElementById('replyExcerpt');
const replyCancel = document.getElementById('replyCancel');
replyCancel.addEventListener('click', clearReply);
function setReply(ctx){ replyContext = ctx; replyExcerpt.textContent = ctx.preview || ''; replyBar.style.display = 'flex'; }
function clearReply(){ replyContext = null; replyBar.style.display = 'none'; replyExcerpt.textContent = ''; }

/* ===== Persistência local do timer ===== */
const TIMER_KEY = `timer:${ROOM}`;
function saveTimerLocal(state){ try{ localStorage.setItem(TIMER_KEY, JSON.stringify(state)); }catch(_){} }
function loadTimerLocal(){ try{ return JSON.parse(localStorage.getItem(TIMER_KEY) || "{}"); }catch(_){ return {}; } }
function applyTimerLocalOnLoad(){ const st = loadTimerLocal(); if (Number.isFinite(st.pausedSec)){ segundos = Math.max(0, st.pausedSec|0); updateTimer(); } else { segundos = 0; updateTimer(); } }

/* ===== SOCKET ===== */
const socket = io({ transports: ["websocket", "polling"] });

socket.on("connect", () => {
  socket.emit("register", { role: ROLE, room: ROOM, name: ROLE === "cliente" ? "Cliente" : "Atendente", uid: UID });

  initAvatar();

  if (ROLE === "cliente") { centerRow.style.display = "flex"; setChatEnabled(false); }
  if (!restored) restoreHistory();

  applyTimerLocalOnLoad();

  requestAnimationFrame(scrollDown);
  updateActionBtnState();
});

socket.on("queue_size", ({ size }) => { const chip = document.getElementById("chipEspera"); if (chip) chip.textContent = String(size); });
socket.on("queue_join", () => { if (ROLE === "atendente") playSound("sndQueue"); });

socket.on("paired", () => {
  isPaired = true;
  avatarImg.classList.add('online');
  timerEl.classList.toggle('running', !!cronometro);
  centerRow.style.display = "none";
  setChatEnabled(true);
  if (ROLE === "cliente" && history.length === 0) {
    addMessage("Conectado ao atendente.", "client", genUID(), true);
    history.push({ t:"text", sender:"client", text:"Conectado ao atendente.", id: genUID(), seen: true }); saveHistory();
  }
  if (ROLE === 'atendente'){
    const av = sessionStorage.getItem(AVATAR_KEY);
    if (av) { try { socket.emit("chat_image", { dataUrl: av, alt: "__avatar__" }); } catch(_){} }
  }
  scrollDown(); updateActionBtnState();
});

/* ===== INDICADOR REMOTO: “gravando áudio…” ===== */
function showRemoteRecording(){ recordingHint.style.display = 'block'; scrollDown(); }
function hideRemoteRecording(){ recordingHint.style.display = 'none'; }
socket.on("recording", ({ from, state })=>{
  const other = (from === "attendant" && ROLE === "cliente") || (from === "client" && ROLE === "atendente");
  if (!other) return;
  if (state === "start") showRemoteRecording(); else hideRemoteRecording();
});

/* ===== Digitando ===== */
const typingHint = document.getElementById("typingHint");
let typingHideTimer = null;
function showTypingBubble(){
  typingHint.style.display = "block";
  scrollDown();
  clearTimeout(typingHideTimer);
  typingHideTimer = setTimeout(()=>{ typingHint.style.display="none"; }, 2000);
}
function hideTypingBubble(){
  typingHint.style.display = "none";
  clearTimeout(typingHideTimer);
  typingHideTimer = null;
}
msgInput.addEventListener("input", ()=>{
  if (ROLE === "cliente" && !isPaired) return;
  updateActionBtnState();
  socket.emit("typing", { isTyping: msgInput.value.trim().length > 0 });
  clearTimeout(window.__typingEmitTimer);
  window.__typingEmitTimer = setTimeout(()=>{ socket.emit("typing", { isTyping:false }); }, 1500);
});
msgInput.addEventListener("blur", ()=>{ socket.emit("typing", { isTyping:false }); });
msgInput.addEventListener("keydown", (e)=>{ if (e.key === "Enter"){ e.preventDefault(); if (msgInput.value.trim()) sendMessage(); } });
socket.on("typing", ({ from, isTyping }) => {
  const isOther = ((from === "attendant" && ROLE === "cliente") || (from === "client" && ROLE === "atendente"));
  if (!isOther) return;
  if (isTyping) showTypingBubble(); else hideTypingBubble();
});

/* ===== Timer / Encerrar ===== */
socket.on("timer_state", ({ running, elapsedSec }) => {
  segundos = elapsedSec || 0;
  if (running){ saveTimerLocal({ running:true, startTs: Date.now() - (segundos*1000), pausedSec:0 }); iniciarCronometro(true); }
  else { pararCronometro(true); saveTimerLocal({ running:false, startTs:0, pausedSec:segundos }); }
  updateTimer();
});

socket.on("conversation_ended", ({ reason }) => {
  clearInterval(cronometro); cronometro = null; segundos = 0; updateTimer();
  timerEl.classList.remove('running'); avatarImg.classList.remove('online');
  try{ localStorage.removeItem(TIMER_KEY); }catch(_){}
  showEnded(reason); clearHistory(); chatBody.innerHTML = "";
  hideRemoteRecording();
  try { socket.emit("queue_sync", { room: ROOM }); } catch(_){ }
  if (ROLE === "cliente") {
    const END_URL = "https://atendimento2.onrender.com/encerrado.html?v=" + Date.now();
    const box=document.createElement('div'); box.style.cssText="text-align:center;padding:12px;"; box.innerHTML=`🔁 Redirecionando para a avaliação…<br><a href="${END_URL}" style="font-weight:700;" target="_top" rel="noopener">Ir agora</a>`;
    document.body.appendChild(box);
    setTimeout(()=>{ try{ window.location.replace(END_URL);}catch(_){ window.location.href=END_URL; } }, 800);
  }
});

/* ===== Controles do atendente (RESTAURADOS) ===== */
const btnProximo=document.getElementById("btnProximo");
const btnTimer=document.getElementById("btnTimer");
const endBtn=document.getElementById("endBtn");
if (ROLE !== "atendente"){ btnProximo.style.display="none"; btnTimer.style.display="none"; }
btnProximo.addEventListener("click", ()=> socket.emit("next_in_queue"));
btnTimer.addEventListener("click", ()=>{
  if(cronometro){ pararCronometro(); btnTimer.innerHTML='<span class="dot"></span> Iniciar tempo'; btnTimer.classList.remove("stop"); }
  else { iniciarCronometro(); btnTimer.innerHTML='<span class="dot"></span> Parar tempo'; btnTimer.classList.add("stop"); }
});
endBtn.addEventListener("click", ()=> socket.emit("end_conversation"));

/* ===== UI helpers ===== */
function updateTimer(){ const m=String(Math.floor(segundos/60)).padStart(2,'0'); const s=String(segundos%60).padStart(2,'0'); timerEl.textContent=`⏱️ ${m}:${s}`; }
function iniciarCronometro(silent){ if (!cronometro){ const startTs=Date.now()-(segundos*1000); saveTimerLocal({running:true, startTs, pausedSec:0}); cronometro=setInterval(()=>{ segundos++; updateTimer(); },1000); timerEl.classList.add('running'); if(!silent) socket.emit("timer_start"); } }
function pararCronometro(silent){ clearInterval(cronometro); cronometro=null; saveTimerLocal({running:false, startTs:0, pausedSec:segundos}); timerEl.classList.remove('running'); if(!silent) socket.emit("timer_stop"); }
function scrollDown(){ chatBody.scrollTop = chatBody.scrollHeight; }
function setChatEnabled(enabled){
  const input=document.getElementById('msgInput');
  if (enabled){ input.removeAttribute('disabled'); actionBtn.disabled=false; }
  else { input.setAttribute('disabled','disabled'); actionBtn.disabled=true; }
  updateActionBtnState();
}
function showEnded(reason){
  const ended=document.getElementById("chat-ended");
  ended.textContent = reason==="attendant_left"?"⚠️ Atendente desconectou":(reason==="client_left"?"⚠️ Cliente desconectou":"✅ Conversa encerrada");
  ended.style.display="block"; setTimeout(()=>{ ended.style.display="none"; },1500);
}
function clearHistory(){ try{ sessionStorage.removeItem(STORE_KEY); }catch(_){ } history=[]; }

/* ===== Sons ===== */
let soundEnabled=true, audioReady=false;
function unlockAudioOnce(){ if (audioReady) return; const tryUnlock=(id)=>{ const a=document.getElementById(id); if(!a) return; a.muted=true; a.play().then(()=>{ a.pause(); a.currentTime=0; a.muted=false; a.volume=1; audioReady=true; }).catch(()=>{}); }; tryUnlock("sndSend"); tryUnlock("sndRecv"); tryUnlock("sndQueue"); }
window.addEventListener("pointerdown", unlockAudioOnce, { once:true });
function playSound(id){ if(!soundEnabled) return; const a=document.getElementById(id); if(a){ try{ a.currentTime=0; a.play(); }catch(_){} } }
const toggleBtn=document.getElementById("toggleSound");
toggleBtn.addEventListener("click", ()=>{ soundEnabled=!soundEnabled; toggleBtn.classList.toggle("off", !soundEnabled); toggleBtn.textContent = soundEnabled ? "🔔" : "🔕"; unlockAudioOnce(); });

/* ===== Envio (inclui reply) ===== */
function sendMessage(){
  if (ROLE === "cliente" && !isPaired) return;
  const msg = msgInput.value.trim(); if (!msg) return;
  const id = genUID();
  const sender = (ROLE==="atendente"?"attendant":"client");
  const reply = replyContext ? { id: replyContext.id, preview: replyContext.preview } : null;

  addMessage(msg, sender, id, false, reply);
  history.push({ t:"text", sender, text: msg, id, seen:false, reply }); saveHistory();

  socket.emit("chat_message", { text: msg, id, reply });
  socket.emit("typing", { isTyping:false });

  if (reply && reply.preview){
    try{
      const alt = `__reply__|${id}|${encodeURIComponent(reply.preview)}`;
      socket.emit("chat_image", { dataUrl:"data:application/json;base64,MA==", alt, id });
    }catch(_){}
  }

  playSound("sndSend");
  msgInput.value = ""; clearReply(); updateActionBtnState(); hideTypingBubble(); scrollDown();
}

/* ===== Estado do FAB ===== */
function updateActionBtnState(){
  const hasText = msgInput.value.trim().length > 0;
  if (isRecording()){
    actionBtn.classList.add('send'); actionBtn.classList.remove('mic'); actionBtn.title = 'Enviar áudio'; return;
  }
  if (hasText){ actionBtn.classList.add('send'); actionBtn.classList.remove('mic'); actionBtn.title='Enviar mensagem'; }
  else { actionBtn.classList.add('mic'); actionBtn.classList.remove('send'); actionBtn.title='Gravar áudio'; }
}

/* ===== Imagem ===== */
const fileBtn=document.getElementById('fileBtn'); const fileInput=document.getElementById('fileInput');
fileBtn.addEventListener('click', ()=>{ if (ROLE === "cliente" && !isPaired) return; fileInput.click(); });
fileInput.addEventListener('change', async (e)=>{
  const f=e.target.files && e.target.files[0]; if(!f) return;
  if (!f.type.startsWith('image/')){ addMessage("Apenas imagens são suportadas aqui.", (ROLE==="atendente"?"attendant":"client")); return; }
  const reader=new FileReader();
  reader.onload = async ()=>{
    const dataUrl=await downscaleDataUrl(reader.result, 960);
    const id=genUID();
    const sender=(ROLE==="atendente"?"attendant":"client");
    const reply = replyContext ? { id: replyContext.id, preview: replyContext.preview } : null;

    addImageMessage(dataUrl, sender, f.name||"Imagem", id, false, reply);
    history.push({ t:"img", sender, dataUrl, alt:f.name||"Imagem", id, seen:false, reply }); saveHistory();

    socket.emit("chat_image", { dataUrl, alt:f.name||"Imagem", id, reply });

    if (reply && reply.preview){
      try{ socket.emit("chat_image", { dataUrl:"data:application/json;base64,MA==", alt:`__reply__|${id}|${encodeURIComponent(reply.preview)}`, id }); }catch(_){}
    }

    playSound("sndSend"); fileInput.value=""; clearReply();
  };
  reader.readAsDataURL(f);
});

/* ===== ÁUDIO ===== */
let mediaRecorder=null, recChunks=[], recStartTs=0, recStopTimer=null, activeStream=null;
let wavRecorder=null;

function pickBestAudioMime(){
  const tries=['audio/mp4;codecs=mp4a.40.2','audio/mp4','audio/webm;codecs=opus','audio/ogg;codecs=opus','audio/webm','audio/ogg'];
  if(!window.MediaRecorder || !MediaRecorder.isTypeSupported) return '';
  return tries.find(t=>MediaRecorder.isTypeSupported(t)) || '';
}
function isRecording(){ return (mediaRecorder && mediaRecorder.state==='recording') || (wavRecorder && wavRecorder.recording); }

/* ===== UI rec bar helpers ===== */
function showRecBar(){ recBar.classList.add('show'); startMeterAnimation(); }
function hideRecBar(){ recBar.classList.remove('show'); stopMeterAnimation(); }
function fmtSec(s){ const m=Math.floor(s/60), r=s%60; return `${m}:${String(r).padStart(2,'0')}`; }
function startMeterAnimation(){
  const dots = recMeter.querySelectorAll('.dot');
  let t=0; recUITimer = setInterval(()=>{ t+=1; dots.forEach((d,i)=>{ const p=(Math.sin((t+i)/2)+1)/2; d.style.transform=`scale(${0.6 + p*0.8})`; d.style.opacity=String(0.5 + p*0.5); }); }, 80);
}
function stopMeterAnimation(){ if(recUITimer){ clearInterval(recUITimer); recUITimer=null; } }

/* ===== startRecording: emite “recording start” para o outro ===== */
async function startRecording(){
  if (ROLE === "cliente" && !isPaired) return;
  try{
    const constraints={ audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true, channelCount:1 } };
    const stream=await navigator.mediaDevices.getUserMedia(constraints); activeStream=stream;

    const useMR=!!window.MediaRecorder; const mime=pickBestAudioMime();
    if(useMR){
      try{
        mediaRecorder=new MediaRecorder(stream, mime?{mimeType:mime}:undefined);
        recChunks=[]; recStartTs=Date.now();
        mediaRecorder.ondataavailable=(ev)=>{ if(ev.data && ev.data.size) recChunks.push(ev.data); };
        mediaRecorder.onstop=onMediaRecorderStop;
        mediaRecorder.start(200);
      }catch(err){ await startWavFallback(stream); }
    }else{ await startWavFallback(stream); }

    // UI
    showRecBar(); recPaused=false;
    actionBtn.classList.add('send'); actionBtn.classList.remove('mic'); actionBtn.title = 'Enviar áudio'; updateActionBtnState();

    // tempo e autostop
    const t0 = Date.now();
    if (window.__recTimeInt) clearInterval(window.__recTimeInt);
    window.__recTimeInt = setInterval(()=>{ const secs = Math.max(0, Math.round((Date.now()-t0)/1000)); recTime.textContent = fmtSec(secs); }, 250);
    recStopTimer=setTimeout(()=>{ if(isRecording()) stopRecording(); }, 60000);

    // avisa o par
    try{ socket.emit("recording", { state:"start", from: (ROLE==="atendente"?"attendant":"client") }); }catch(_){}
  }catch(err){
    console.error(err);
    addMessage("Permita acesso ao microfone para enviar áudio.", (ROLE==="atendente"?"attendant":"client"));
  }
}

function stopRecording(){
  try{
    if(mediaRecorder && mediaRecorder.state==='recording'){ mediaRecorder.stop(); }
    else if(wavRecorder && wavRecorder.recording){ wavRecorder.stop().then(({blob, durSec})=>handleAudioBlob(blob, durSec)); }
  }catch(_){}
}

function onMediaRecorderStop(){
  clearTimeout(recStopTimer); recStopTimer=null;
  const durSec=Math.max(1, Math.round((Date.now()-recStartTs)/1000));
  const blobType=(mediaRecorder && mediaRecorder.mimeType)? mediaRecorder.mimeType : (recChunks[0] && recChunks[0].type) || 'audio/mp4';
  const blob=new Blob(recChunks,{type:blobType}); handleAudioBlob(blob, durSec);
}

function handleAudioBlob(blob, durSec){
  const fr=new FileReader();
  fr.onload=()=>{
    const dataUrl=fr.result; const id=genUID();
    const sender=(ROLE==="atendente"?"attendant":"client");
    const reply = replyContext ? { id: replyContext.id, preview: replyContext.preview } : null;

    addAudioMessage(dataUrl, sender, durSec, id, false, reply);
    history.push({ t:"aud", sender, dataUrl, dur:durSec, id, seen:false, reply }); saveHistory();

    socket.emit("chat_audio", { dataUrl, durSec, id, reply });

    if (reply && reply.preview){
      try{ socket.emit("chat_image", { dataUrl:"data:application/json;base64,MA==", alt:`__reply__|${id}|${encodeURIComponent(reply.preview)}`, id }); }catch(_){ }
    }

    playSound("sndSend"); clearReply();
  };
  fr.readAsDataURL(blob);

  // limpeza
  if(activeStream){ try{ activeStream.getTracks().forEach(t=>t.stop()); }catch(_){} }
  activeStream=null; mediaRecorder=null; wavRecorder=null;

  updateActionBtnState();
  hideRecBar(); recPaused=false;
  if (window.__recTimeInt){ clearInterval(window.__recTimeInt); window.__recTimeInt=null; }

  // avisa par
  try{ socket.emit("recording", { state:"stop", from: (ROLE==="atendente"?"attendant":"client") }); }catch(_){}
}

async function startWavFallback(stream){
  wavRecorder=new WavFallbackRecorder(stream); await wavRecorder.start();
}
class WavFallbackRecorder{
  constructor(stream){ this.stream=stream; this.ctx=null; this.source=null; this.processor=null; this.buffers=[]; this.recording=false; this.startTs=0; }
  async start(){ const AC=window.AudioContext||window.webkitAudioContext; this.ctx=new AC(); this.source=this.ctx.createMediaStreamSource(this.stream); const bufferSize=4096; this.processor=this.ctx.createScriptProcessor(bufferSize,1,1); this.source.connect(this.processor); this.processor.connect(this.ctx.destination); this.processor.onaudioprocess=(e)=>{ if(!this.recording) return; const ch0=e.inputBuffer.getChannelData(0); this.buffers.push(new Float32Array(ch0)); }; this.recording=true; this.startTs=Date.now(); }
  async stop(){ this.recording=false; try{ this.processor.disconnect(); }catch(_){ } try{ this.source.disconnect(); }catch(_){ } try{ await this.ctx.close(); }catch(_){ } try{ this.stream.getTracks().forEach(t=>t.stop()); }catch(_){ }
    const len=this.buffers.reduce((a,b)=>a+b.length,0); const data=new Float32Array(len); let off=0; for(const b of this.buffers){ data.set(b, off); off+=b.length; }
    const wavBlob=floatToWavBlob(data,1,44100); const durSec=Math.max(1, Math.round((Date.now()-this.startTs)/1000)); return { blob:wavBlob, durSec }; }
}
function floatToWavBlob(float32,numChannels,sampleRate){
  const bytesPerSample=2, blockAlign=numChannels*bytesPerSample, buffer=new ArrayBuffer(44+float32.length*bytesPerSample), view=new DataView(buffer);
  writeString(view,0,'RIFF'); view.setUint32(4,36+float32.length*bytesPerSample,true); writeString(view,8,'WAVE'); writeString(view,12,'fmt '); view.setUint32(16,16,true); view.setUint16(20,1,true); view.setUint16(22,numChannels,true); view.setUint32(24,sampleRate,true); view.setUint32(28,sampleRate*blockAlign,true); view.setUint16(32,blockAlign,true); view.setUint16(34,8*bytesPerSample,true); writeString(view,36,'data'); view.setUint32(40,float32.length*bytesPerSample,true);
  let offset=44; for(let i=0;i<float32.length;i++){ let s=Math.max(-1, Math.min(1, float32[i])); view.setInt16(offset, s<0 ? s*0x8000 : s*0x7FFF, true); offset+=2; }
  return new Blob([view],{type:'audio/wav'});
}
function writeString(view,offset,str){ for(let i=0;i<str.length;i++){ view.setUint8(offset+i, str.charCodeAt(i)); } }

/* ===== Botões da barra de gravação ===== */
recPauseBtn.addEventListener('click', ()=>{
  if (!mediaRecorder || !('pause' in mediaRecorder)) { alert('Pausar não é suportado neste dispositivo.'); return; }
  if (!recPaused){ mediaRecorder.pause(); recPaused=true; recPauseBtn.textContent='Retomar'; }
  else { mediaRecorder.resume(); recPaused=false; recPauseBtn.textContent='⏸️ Pausar'; }
});

recTrashBtn.addEventListener('click', ()=>{
  try{
    clearTimeout(recStopTimer); recStopTimer=null; recChunks=[];
    if (mediaRecorder && mediaRecorder.state!=='inactive'){ mediaRecorder.stop(); }
    if (wavRecorder && wavRecorder.recording){ wavRecorder.stop().then(()=>{}); }
  }catch(_){}
  if(activeStream){ try{ activeStream.getTracks().forEach(t=>t.stop()); }catch(_){} }
  activeStream=null; mediaRecorder=null; wavRecorder=null;
  updateActionBtnState(); hideRecBar(); recPaused=false;
  if (window.__recTimeInt){ clearInterval(window.__recTimeInt); window.__recTimeInt=null; }
  try{ socket.emit("recording", { state:"stop", from: (ROLE==="atendente"?"attendant":"client") }); }catch(_){}
});

/* ===== Clique do FAB ===== */
actionBtn.addEventListener('pointerdown', unlockAudioOnce, { once:true });
actionBtn.addEventListener('click', ()=>{
  if (ROLE === "cliente" && !isPaired) return;
  const hasText=msgInput.value.trim().length>0;
  if(isRecording()){ stopRecording(); return; }      // clicou p/ ENVIAR o áudio
  if(hasText) sendMessage(); else startRecording();  // texto → envia / vazio → grava
});

/* ===== Mensagens / Imagens / Áudio helpers (mesmos do seu arquivo) ===== */
function addMessage(text, sender, id = genUID(), seen = false, reply=null){
  const d=document.createElement('div'); d.classList.add('message', sender);
  const mySide = (ROLE === "atendente") ? "attendant" : "client";
  const isMine=(sender===mySide); d.classList.add(isMine?'mine':'theirs');
  d.dataset.id=id;
  const bubble=document.createElement('div'); bubble.className='bubble';
  if (reply && reply.preview){ const q=document.createElement('div'); q.className='reply-quote'; q.textContent=reply.preview; bubble.appendChild(q); }
  const t=document.createElement('div'); t.className='text'; t.textContent=text; bubble.appendChild(t);
  d.appendChild(bubble);
  if(isMine){ const meta=document.createElement('div'); meta.className='meta'; const rc=document.createElement('span'); rc.className='receipt'+(seen?' seen':''); rc.id=`rcp-${id}`; rc.innerHTML='<span class="check">✓</span><span class="check">✓</span>'; meta.appendChild(rc); d.appendChild(meta); }
  chatBody.appendChild(d); scrollDown();
}
function addImageMessage(dataUrl, sender, alt="Imagem", id = genUID(), seen=false, reply=null){
  const d=document.createElement('div'); d.classList.add('message', sender);
  const mySide = (ROLE === "atendente") ? "attendant" : "client";
  const isMine=(sender===mySide); d.classList.add(isMine?'mine':'theirs');
  d.dataset.id=id;
  const bubble=document.createElement('div'); bubble.className='bubble';
  if (reply && reply.preview){ const q=document.createElement('div'); q.className='reply-quote'; q.textContent=reply.preview; bubble.appendChild(q); }
  const w=document.createElement('div'); w.className='image';
  const i=document.createElement('img'); i.src=dataUrl; i.alt=alt; w.appendChild(i); bubble.appendChild(w);
  d.appendChild(bubble);
  if(isMine){ const meta=document.createElement('div'); meta.className='meta'; const rc=document.createElement('span'); rc.className='receipt'+(seen?' seen':''); rc.id=`rcp-${id}`; rc.innerHTML='<span class="check">✓</span><span class="check">✓</span>'; meta.appendChild(rc); d.appendChild(meta); }
  chatBody.appendChild(d); scrollDown();
}
function addAudioMessage(dataUrl, sender, durSec=0, id = genUID(), seen=false, reply=null){
  const d=document.createElement('div'); d.classList.add('message', sender);
  const mySide = (ROLE === "atendente") ? "attendant" : "client";
  const isMine=(sender===mySide); d.classList.add(isMine?'mine':'theirs');
  d.dataset.id=id;
  const bubble=document.createElement('div'); bubble.className='bubble';
  if (reply && reply.preview){ const q=document.createElement('div'); q.className='reply-quote'; q.textContent=reply.preview; bubble.appendChild(q); }
  const wrap=document.createElement('div'); wrap.className='audio-wrap';
  const audio=document.createElement('audio'); audio.controls=true; audio.preload="metadata"; audio.src=dataUrl; wrap.appendChild(audio);
  const dur=document.createElement('div'); dur.className='duration'; dur.textContent = durSec ? `⏱️ ${String(Math.floor(durSec/60)).padStart(2,'0')}:${String(Math.floor(durSec%60)).padStart(2,'0')}` : 'Áudio';
  wrap.appendChild(dur);
  bubble.appendChild(wrap);
  d.appendChild(bubble);
  if(isMine){ const meta=document.createElement('div'); meta.className='meta'; const rc=document.createElement('span'); rc.className='receipt'+(seen?' seen':''); rc.id=`rcp-${id}`; rc.innerHTML='<span class="check">✓</span><span class="check">✓</span>'; meta.appendChild(rc); d.appendChild(meta); }
  chatBody.appendChild(d); scrollDown();
}

/* ===== PRINT TAROT ===== */
const DECK=[{n:0,nome:"O Louco",img:'cards/o-louco.jpg'},{n:1,nome:"O Mago",img:'cards/o-mago.jpg'},{n:2,nome:"A Sacerdotisa",img:'cards/a-sacerdotisa.jpg'},{n:3,nome:"A Imperatriz",img:'cards/a-imperatriz.jpg'},{n:4,nome:"O Imperador",img:'cards/o-imperador.jpg'},{n:5,nome:"O Papa",img:'cards/o-papa.jpg'},{n:6,nome:"Os Enamorados",img:'cards/os-enamorados.jpg'},{n:7,nome:"O Carro",img:'cards/o-carro.jpg'},{n:8,nome:"A Força",img:'cards/a-forca.jpg'},{n:9,nome:"O Eremita",img:'cards/o-eremita.jpg'},{n:10,nome:"A Roda da Fortuna",img:'cards/a-roda-da-fortuna.jpg'},{n:11,nome:"A Justiça",img:'cards/a-justica.jpg'},{n:12,nome:"O Enforcado",img:'cards/o-enforcado.jpg'},{n:13,nome:"A Morte",img:'cards/a-morte.jpg'},{n:14,nome:"A Temperança",img:'cards/a-temperanca.jpg'},{n:15,nome:"O Diabo",img:'cards/o-diabo.jpg'},{n:16,nome:"A Torre",img:'cards/a-torre.jpg'},{n:17,nome:"A Estrela",img:'cards/a-estrela.jpg'},{n:18,nome:"A Lua",img:'cards/a-lua.jpg'},{n:19,nome:"O Sol",img:'cards/o-sol.jpg'},{n:20,nome:"O Julgamento",img:'cards/o-julgamento.jpg'},{n:21,nome:"O Mundo",img:'cards/o-mundo.jpg'}];
const board=document.getElementById("board"); let selecionadas=[];
function cryptoRandomInt(maxExclusive){ const c=window.crypto||window.msCrypto; if(!c) return Math.floor(Math.random()*maxExclusive); const a=new Uint32Array(1); c.getRandomValues(a); return a[0]%maxExclusive; }
function shuffleCrypto(arr){ for(let i=arr.length-1;i>0;i--){ const j=cryptoRandomInt(i+1); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
function sortear(n){ const idx=Array.from(DECK.keys()); shuffleCrypto(idx); return idx.slice(0,n); }
function montarCarta(deckIndex){
  const data=DECK[deckIndex];
  const slot=document.createElement("div"); slot.className="slot";
  const card=document.createElement("div"); card.className="card"; card.tabIndex=0;
  const back=document.createElement("div"); back.className="face back";
  const backImg=document.createElement("img"); backImg.src="cards/back.png"; backImg.alt="Verso"; backImg.decoding="async"; backImg.loading="eager"; backImg.style.width="100%"; backImg.style.height="100%"; backImg.style.objectFit="cover"; back.appendChild(backImg);
  const front=document.createElement("div"); front.className="face front";
  const img=document.createElement("img"); img.alt=data.nome; img.src=data.img; img.style.width="100%"; img.style.height="100%"; img.style.objectFit="cover"; front.appendChild(img);
  const flip=()=>{ card.classList.toggle("flipped"); };
  card.addEventListener("click", flip);
  card.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); flip(); } });
  card.appendChild(back); card.appendChild(front); slot.appendChild(card); return slot;
}
function renderBoard(){ board.innerHTML=""; selecionadas.forEach((i)=> board.appendChild(montarCarta(i))); }
(function initTarot(){ selecionadas=sortear(6); renderBoard(); })();

/* ===== PRINT ===== */
const TARGET_WIDTH=320;
async function downscaleDataUrl(dataUrl, targetW=TARGET_WIDTH){
  return new Promise((resolve)=>{ const img=new Image(); img.onload=()=>{ const ratio=Math.min(targetW/img.width,1); const canvas=document.createElement('canvas'); canvas.width=Math.round(img.width*ratio); canvas.height=Math.round(img.height*ratio); canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height); resolve(canvas.toDataURL('image/png')); }; img.src=dataUrl; });
}
document.getElementById("btnTarotPrint").addEventListener("click", async ()=>{
  const target=document.querySelector("#lenRoot");
  try{
    const canvas=await html2canvas(target,{ backgroundColor:null, scale:1 });
    const raw=canvas.toDataURL("image/png");
    const thumb=await downscaleDataUrl(raw, TARGET_WIDTH);
    const id=genUID();
    addImageMessage(thumb, ROLE==="atendente"?"attendant":"client", "Leitura de Tarot", id, false);
    history.push({ t:"img", sender: ROLE==="atendente"?"attendant":"client", dataUrl: thumb, alt:"Leitura de Tarot", id, seen:false }); saveHistory();
    socket.emit("chat_image", { dataUrl: thumb, alt:"Leitura de Tarot", id });
  }catch(err){
    console.error("Falha ao gerar print:", err);
    addMessage("Não foi possível gerar o print das cartas neste momento.", ROLE==="atendente"?"attendant":"client");
    history.push({ t:"text", sender: ROLE==="atendente"?"attendant":"client", text:"Não foi possível gerar o print das cartas neste momento." }); saveHistory();
  }
});

/* ===== Sair da fila ao fechar (cliente) ===== */
function notifyLeavingQueue(){
  try{
    if (ROLE === "cliente" && !isPaired) {
      socket.emit("leave_queue", { uid: UID, room: ROOM });
      socket.emit("queue_sync", { room: ROOM });
    }
  }catch(e){}
}
addEventListener("beforeunload", notifyLeavingQueue);
addEventListener("pagehide", notifyLeavingQueue);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Chat + Tarot (tempo real) ‚Äî Responsivo</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --vh:1vh;
      --safe-bottom:env(safe-area-inset-bottom,0px);
      --safe-top:env(safe-area-inset-top,0px);
      /* Larguras responsivas principais */
      --chat-max: 500px;   /* mobile padr√£o */
      --gap: 26px;
    }
    *{box-sizing:border-box}
    html,body{ height:100%; }
    body{ font-family:Arial, sans-serif; background:#1d1f21; margin:0; padding:0; color:#111; }

    /* üé¥ Tabuleiro de cartas (#board) ‚Äî colunas por dispositivo */
    #board{
      display:grid;
      gap:1rem;             /* pode trocar por var(--gap) se preferir */
      justify-content:center;
    }
    /* üì± celular ‚Üí 6 (3 colunas √ó 2 linhas) */
@media (max-width: 767px){
  #board{ grid-template-columns: repeat(3, 1fr); }
}
    /* üì≤ tablet ‚Üí 8 (4 colunas) */
    @media (min-width: 768px) and (max-width: 1024px){
      #board{ grid-template-columns: repeat(4, 1fr); }
    }
    /* üñ•Ô∏è pc ‚Üí 6 (3 em cima, 3 em baixo) */
    @media (min-width: 1025px){
      #board{ grid-template-columns: repeat(3, 1fr); }
    }

    /* ====== LAYOUT DE P√ÅGINA (lado a lado quando couber) ====== */
    .page{ display:grid; gap:16px; align-items:start; padding:12px; max-width:min(100%, 1280px); margin:0 auto; }
    /* mobile = 1 coluna */
    .col{ min-width:0; }
    /* a partir de tablet, 2 colunas: chat | tarot */
    @media (min-width: 900px){
      .page{ grid-template-columns: 1fr 1fr; }
      .col.chat-col{ order:1; }
      .col.tarot-col{ order:2; position:sticky; top:12px; }
    }

    /* ====== FILA ====== */
    .fila-container{ width:100%; max-width:var(--chat-max); margin:16px auto 8px; background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); border-radius:14px; padding:12px; box-shadow:0 6px 20px rgba(0,0,0,.25); display:flex; align-items:center; gap:12px; justify-content:space-between; color:#e5e7eb; border:1px solid #2a2f36; }
    .fila-info{ display:flex; align-items:center; gap:10px; }
    .bolinha{ width:10px; height:10px; border-radius:50%; background:#00c800; animation:piscar 1s infinite; }
    .chip{ display:flex; align-items:center; justify-content:center; min-width:36px; height:28px; background:#111827; padding:0 10px; border-radius:20px; color:#e5e7eb; font-size:14px; font-weight:700; border:1px solid #374151;}
    .fila-actions{ display:flex; gap:10px;}
    .btn-proximo,.btn-timer{ display:inline-flex; align-items:center; gap:8px; background:#016e35; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-size:14px; font-weight:700; box-shadow:0 6px 14px rgba(1,110,53,.28); transition:transform .06s, box-shadow .2s, background .2s; }
    .btn-proximo:hover,.btn-timer:hover{ transform:translateY(-1px); box-shadow:0 10px 18px rgba(1,110,53,.33); }
    .btn-timer.stop{ background:#b91c1c; box-shadow:0 6px 14px rgba(185,28,28,.28); }
    .btn-timer .dot{ width:8px; height:8px; border-radius:50%; background:#fff; box-shadow:0 0 0 0 rgba(255,255,255,.6); }
    .btn-timer.stop .dot{ animation:pulseDot 1.2s infinite; }
    @keyframes pulseDot{0%{box-shadow:0 0 0 0 rgba(255,255,255,.5)}70%{box-shadow:0 0 0 8px rgba(255,255,255,0)}100%{box-shadow:0 0 0 0 rgba(255,255,255,0)}}
    body[data-role="cliente"] .fila-container{ display:none!important; }

    /* ====== CHAT ====== */
    .chat-container{ width:100%; max-width:var(--chat-max); height:min(calc(var(--vh)*100), 92vh); margin:0 auto 12px; background:#f7f7f7; border-radius:12px; box-shadow:0 0 15px rgba(0,0,0,.25); display:flex; flex-direction:column; overflow:hidden; position:relative; }

    .chat-header{ position:sticky; top:0; z-index:2; display:flex; align-items:center; gap:10px; background:#fff; padding:12px 12px calc(12px + var(--safe-top)); color:#0f172a; border-bottom:1px solid #e5e7eb; box-shadow:0 1px 3px rgba(0,0,0,.08); }
    .chat-header strong{ font-size:16px; }
    .timer{ font-size:14px; margin-left:auto; color:#0f172a; display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:rgba(15,23,42,.06); border:1px solid rgba(15,23,42,.12); box-shadow:inset 0 0 6px rgba(0,0,0,.04); }
    .timer.running{ animation:pulseTimer 2s ease-in-out infinite; }
    .btn-som{ margin-left:8px; background:#e5e7eb; color:#0f172a; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:14px; }
    .btn-som.off{ background:#d1d5db; color:#111827; }

    .chat-header .avatar{ width:56px; height:56px; border-radius:50%; border:2px solid #fff; box-shadow:0 1px 2px rgba(0,0,0,.15); object-fit:cover; background:#e5e7eb; flex:0 0 auto; cursor:pointer; transition:box-shadow .2s; }
    .chat-header .avatar.online{ box-shadow:0 0 0 3px #22c55e,0 0 0 6px #fff,0 2px 4px rgba(0,0,0,.18); }

    .chat-body{ flex:1; overflow-y:auto; overflow-x:hidden; padding:10px 12px 16px; background-color:#eae6df; background-image:url("imagem/papel-tarot.png"); background-repeat:repeat; background-size:520px auto; background-attachment:fixed; background-position:center; display:flex; flex-direction:column; gap:10px; overscroll-behavior:contain; -webkit-overflow-scrolling:touch; }
    .center-row{ margin:auto; display:none; justify-content:center; align-items:center; width:100%; }

    .message{ margin:2px 0; display:flex; align-items:flex-end; }
    .message.attendant{ justify-content:flex-end; }
    .message.client{ justify-content:flex-start; }

    .message .bubble{ position:relative; padding:10px 12px; border-radius:12px; max-width:82%; line-height:1.35; box-shadow:0 1px 0 rgba(0,0,0,.06); display:inline-block; word-wrap:break-word; overflow-wrap:anywhere; transition:transform .18s, box-shadow .18s; will-change:transform; touch-action:pan-y; -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; }
    .message.attendant .bubble{ background:#d9fdd3; color:#111; border-bottom-right-radius:4px; }
    .message.client .bubble{ background:#fff; color:#222; border-bottom-left-radius:4px; }

    .message.mine{ justify-content:flex-end!important; }
    .message.theirs{ justify-content:flex-start!important; }
    .message.mine .bubble{ background:#d9fdd3; color:#111; border-bottom-right-radius:4px; border-bottom-left-radius:12px; margin-left:auto; margin-right:4px; }
    .message.theirs .bubble{ background:#fff; color:#222; border-bottom-left-radius:4px; border-bottom-right-radius:12px; margin-right:auto; margin-left:4px; }
    .bubble.dragging{ box-shadow:0 6px 18px rgba(0,0,0,.15); }

    .trash-pop{ position:absolute; top:-10px; right:-10px; z-index:3; border:none; border-radius:999px; width:36px; height:36px; display:grid; place-items:center; background:#ef4444; color:#fff; cursor:pointer; box-shadow:0 8px 20px rgba(239,68,68,.35); transform:scale(.9); opacity:0; pointer-events:none; transition:transform .16s, opacity .16s; }
    .bubble.show-trash .trash-pop{ opacity:1; pointer-events:auto; transform:scale(1); }

    .bubble::before{ content:''; position:absolute; left:-14px; top:50%; width:8px; height:8px; border-top:2px solid rgba(0,0,0,.15); border-left:2px solid rgba(0,0,0,.15); transform:translateY(-50%) rotate(-45deg); opacity:0; transition:opacity .15s; }
    .bubble.swipe-hint::before{ opacity:1; }

    .message .text{ margin:0; padding:0; background:transparent; white-space:pre-wrap; }
    .message .image{ margin:0; padding:0; background:transparent; }
    .message .image img,.message .image canvas{ display:block; width:100%; height:auto; border-radius:8px; }

    .message .audio-wrap{ margin:0; padding:0; background:transparent; display:flex; gap:8px; align-items:center; justify-content:flex-end; max-width:100%; }
    .message .audio-wrap audio{ width:240px; max-width:100%; accent-color: #475569; }

    .reply-quote{ font-size:12px; opacity:.85; padding:6px 8px; border-left:3px solid #7c3aed; border-radius:8px; background:rgba(124,58,237,.06); margin-bottom:6px; max-width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .audio-toolbar{ display:inline-flex; gap:6px; align-items:center; }
    .rewind-btn{ border:none; background:rgba(0,0,0,.06); padding:6px 8px; border-radius:8px; cursor:pointer; font-size:14px; }
    .rewind-btn:hover{ filter:brightness(.95); }
    .message .audio-wrap .duration{ font-size:11px; opacity:.7; }

    /* ===== Digitando estilo WhatsApp ===== */
    .typing{ display:none; padding:0 12px; }
    .typing .typing-bubble{
      display:inline-flex; align-items:center; gap:6px;
      background:#fff; color:#444; border-radius:12px; padding:8px 10px;
      box-shadow:0 1px 0 rgba(0,0,0,.06); max-width:60%;
    }
    .typing .dots{ display:inline-flex; gap:4px; }
    .typing .dot{
      width:6px; height:6px; border-radius:50%; background:#9ca3af;
      animation:typingBounce 1.2s infinite ease-in-out;
    }
    .typing .dot:nth-child(2){ animation-delay:.2s; }
    .typing .dot:nth-child(3){ animation-delay:.4s; }
    .typing .typing-text{ font-size:12px; color:#6b7280; margin-left:6px; }
    @keyframes typingBounce{0%,80%,100%{transform:scale(.7);opacity:.65}40%{transform:scale(1);opacity:1}}

    .meta{ font-size:11px; color:#1d78f0; margin-top:4px; display:flex; align-items:center; gap:6px; }
    .receipt{ display:inline-flex; gap:2px; line-height:1; user-select:none; }
    .receipt .check{ font-weight:900; opacity:.65; }
    .receipt.seen .check{ color:#1d9bf0; opacity:1; }

    .chat-footer{ position:sticky; bottom:0; z-index:2; display:grid!important; grid-template-columns:42px 1fr 56px; align-items:center; gap:8px; border-top:1px solid #ddd; background:#f7f7f7; padding:8px 8px calc(8px + var(--safe-bottom)); }

    .reply-bar{ grid-column:1 / -1; display:none; align-items:center; gap:10px; background:#fff; border:1px dashed #c4b5fd; border-radius:10px; padding:6px 10px; margin:6px 0 2px; }
    .reply-bar .excerpt{ flex:1; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .reply-cancel{ background:transparent; border:none; font-size:18px; cursor:pointer; }

    .chat-footer input[type="text"]{ flex:1; padding:12px; border:none; outline:none; font-size:15px; border-radius:8px; background:#fff; }
    .chat-footer button{ background:#016e35; border:none; color:white; padding:10px 16px; cursor:pointer; font-size:14px; border-radius:8px; }
    .icon-btn{ width:42px; height:42px; border-radius:50%; display:grid; place-items:center; padding:0; }
    .icon-btn.secondary{ background:#e5e7eb; color:#111; }

    #endBtn{ background:#b91414; padding:10px 15px; border:none; color:white; margin:10px; border-radius:6px; cursor:pointer; width:calc(100% - 20px); }
    body[data-role="cliente"] #endBtn{ display:none!important; }
    #chat-ended{ text-align:center; padding:20px; color:#016e35; font-weight:bold; display:none; }

    @keyframes piscar{0%{opacity:1}50%{opacity:0}100%{opacity:1}}

    body[data-role="cliente"] #lenRootWrap, body[data-role="cliente"] .tarot-actions{ display:none!important; }
    #lenRoot{ --gap:26px; background:transparent; }
    .layout{display:block}
    .board{ padding:20px 14px 10px; display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:var(--gap); justify-items:center; }
    .slot{ display:grid; place-items:center; width:100%; }
    .card{ width:clamp(100px,28vw,140px); aspect-ratio:62/100; position:relative; border-radius:16px; transform-style:preserve-3d; transition:transform 220ms cubic-bezier(.25,.8,.2,1); cursor:pointer; background:none; border:none; margin:0; box-shadow:0 14px 24px rgba(0,0,0,.28), 0 2px 6px rgba(0,0,0,.25); outline:none; }
    .face{ position:absolute; inset:0; border-radius:16px; overflow:hidden; backface-visibility:hidden; border:none; }
    .front{ transform:rotateY(180deg); display:grid; place-items:center; position:relative; }
    .back{ display:grid; place-items:center; background:#0f2d55; }
    .card.flipped{ transform:rotateY(180deg); }
    #lenRootWrap{ width:100%; max-width:var(--chat-max); margin:8px auto; background:rgba(255,255,255,.06); border-radius:12px; }
    .tarot-actions{ width:100%; max-width:var(--chat-max); margin:8px auto 22px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }

    .waiting-banner{ background:#d32f2f; color:#fff; font-weight:700; text-align:center; padding:12px 14px; border-radius:10px; width:fit-content; max-width:92%; box-shadow:0 2px 8px rgba(0,0,0,.15); user-select:none; pointer-events:none; }

    .disabled{ opacity:.6; pointer-events:none; }
    @media (min-width:601px){ .chat-container{ border-radius:12px; } }

    body[data-role="cliente"] #roleTitle{ display:none!important; }
    body[data-role="atendente"] #roleTitle{ display:none!important; }

    @keyframes pulseTimer{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
    body[data-role="cliente"] .chat-header{ justify-content:center; }
    body[data-role="cliente"] .timer{ margin-left:0; font-size:22px; font-weight:800; letter-spacing:1px; padding:4px 12px; border-radius:999px; border:2px solid rgba(15,23,42,.12); background:rgba(15,23,42,.06); box-shadow:0 0 12px rgba(0,0,0,.08), inset 0 0 6px rgba(0,0,0,.04); animation:pulseTimer 2s ease-in-out infinite; }

    @keyframes ring{0%{transform:rotate(0)}5%{transform:rotate(18deg)}10%{transform:rotate(-14deg)}15%{transform:rotate(10deg)}20%{transform:rotate(-6deg)}25%{transform:rotate(4deg)}30%{transform:0}100%{transform:0}}
    body[data-role="cliente"] .btn-som{ transform-origin:top center; animation:ring 1.4s ease-in-out infinite; }

    body[data-role="cliente"] .message.client{ justify-content:flex-end; }
    body[data-role="cliente"] .message.attendant{ justify-content:flex-start; }
    body[data-role="cliente"] .message.client .bubble{ background:#d9fdd3; color:#111; border-bottom-right-radius:4px; border-bottom-left-radius:12px; }
    body[data-role="cliente"] .message.attendant .bubble{ background:#fff; color:#222; border-bottom-left-radius:4px; border-bottom-right-radius:12px; }

    /* EXTRA mobile muito pequeno */
    @media (max-width:360px){
      .message .bubble{ max-width:88%; }
      .chat-header .avatar{ width:44px; height:44px; }
      .chat-header{ padding:10px; }
      .chat-footer{ grid-template-columns:38px 1fr 50px; }
    }

    .only-client{ display:inline-flex; }

    /* ======= FAB WhatsApp + Barra de Grava√ß√£o ======= */
    :root{ --wa-green:#25D366; --wa-green-dark:#1dae57; --wa-danger:#ed4245; --wa-muted:#9aa0a6; }
    #actionBtn{ width:56px;height:56px;border-radius:50%; display:grid;place-items:center;font-size:0;border:none;cursor:pointer; background:var(--wa-green); box-shadow:0 8px 16px rgba(37,211,102,.35); transition:transform .06s, box-shadow .2s, background .2s; }
    #actionBtn:hover{ transform:translateY(-1px); box-shadow:0 10px 18px rgba(37,211,102,.4); }
    #actionBtn .ico{ width:26px;height:26px; display:block; background-repeat:no-repeat; background-position:center; background-size:26px 26px; }
    #actionBtn.mic .ico{ background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23fff"><path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V21h2v-3.08A7 7 0 0 0 19 11h-2Z"/></svg>'); }
    #actionBtn.send .ico{ background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23fff"><path d="M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"/></svg>'); }

    .rec-bar{ grid-column:1 / -1; display:none; align-items:center; gap:12px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:8px 10px; margin:4px 0 0; }
    .rec-bar.show{ display:flex; }
    .rec-label{ font-weight:700;color:#111;background:#eef2ff;border:1px solid #c7d2fe; padding:6px 10px;border-radius:999px; display:none; }
    .rec-time{ font-weight:700; min-width:42px; }
    .rec-meter{ flex:1; display:flex; align-items:center; gap:6px; }
    .rec-meter .dot{ width:6px;height:6px;border-radius:50%; background:#9ca3af; transform-origin:center bottom; opacity:.8; }
    .rec-btn{ border:none; background:#f3f4f6; color:#111; border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:700; }
    .rec-btn.pause{ background:var(--wa-danger); color:#fff; }
    .rec-btn.trash{ background:#eceff1; color:#444; }
    .rec-btn .i{ width:18px;height:18px; display:inline-block; vertical-align:-4px; background-repeat:no-repeat;background-size:18px 18px;background-position:center; margin-right:6px;}
    .i-pause{ background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" fill="%23fff" viewBox="0 0 24 24"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>'); }
    .i-trash{ background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" fill=\"%23444\" viewBox=\"0 0 24 24\"><path d=\"M6 7h12l-1 13H7L6 7zm3-3h6l1 2H8l1-2z\"/></svg>'); }

    .rec-badge{ display:none; align-items:center; gap:8px; margin-left:8px; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; color:#b91c1c; background:#fee2e2; border:1px solid #fecaca; }
    .rec-badge .dot{ width:8px;height:8px;border-radius:50%; background:#ef4444; box-shadow:0 0 0 0 rgba(239,68,68,.5); animation:pulseDot 1.2s infinite; }
    .rec-badge.show{ display:inline-flex; }

    .message.mine .bubble.audio-heard{ background:#cfe8ff!important; }
    .meta .heard-flag{ font-size:11px; color:#1d9bf0; font-weight:700; }

    .react-picker{ position: fixed; z-index: 9999; display: inline-flex; align-items: center; gap: 6px; padding: 6px 8px; background: #fff; border: 1px solid #e5e7eb; border-radius: 999px; box-shadow: 0 8px 24px rgba(0,0,0,.18); user-select: none; -webkit-user-select: none; animation: rpPop .12s ease-out; }
    .react-picker button{ border: none; background: transparent; font-size: 18px; line-height: 1; cursor: pointer; padding: 6px 8px; border-radius: 999px; }
    .react-picker button:hover{ background:#f3f4f6; }
    .react-picker .reply-opt{ font-size: 14px; padding: 6px 10px; color:#111; border:1px solid #e5e7eb; background:#f9fafb; }
    @keyframes rpPop{ from{ transform: scale(.92); opacity:.0 } to{ transform: scale(1); opacity:1 } }

    .reactions-row{ display: inline-flex; gap: 6px; margin-top: 6px; }
    .reaction-pill{ display:inline-flex; align-items:center; gap: 6px; font-size: 12px; padding: 4px 8px; border-radius: 999px; background:#fff; border:1px solid #e5e7eb; box-shadow:0 1px 0 rgba(0,0,0,.06); }
    .message.mine .reaction-pill{ background:#e8f3ff; border-color:#dbeafe; }

    /* ======= BREAKPOINTS (tablet/desktop) ======= */
    @media (min-width: 640px){
      :root{ --chat-max: 640px; }
      .chat-body{ background-size: 620px auto; }
    }
    @media (min-width: 768px){
      :root{ --chat-max: 760px; }
      .board{ grid-template-columns: repeat(4, minmax(0,1fr)); }
      .card{ width:clamp(110px,18vw,160px); }
    }
    @media (min-width: 1024px){
      :root{ --chat-max: 920px; }
      .board{ grid-template-columns: repeat(5, minmax(0,1fr)); }
      .card{ width:clamp(120px,14vw,180px); }
      .chat-header strong{ font-size:18px; }
      .timer{ font-size:15px; }
    }
    @media (min-width: 1280px){
      :root{ --chat-max: 1040px; }
      .board{ grid-template-columns: repeat(6, minmax(0,1fr)); }
    }
  </style>
</head>
<body data-role="">
<div class="page">
  <div class="col chat-col">
    <!-- Fila -->
    <div class="fila-container">
      <div class="fila-info">
        <div class="bolinha" aria-hidden="true"></div>
        <div>Clientes em espera:</div>
        <div class="chip" id="chipEspera">0</div>
      </div>
      <div class="fila-actions">
        <button class="btn-proximo" id="btnProximo">‚è≠Ô∏è Pr√≥ximo da fila</button>
        <button class="btn-timer" id="btnTimer"><span class="dot"></span> Iniciar tempo</button>
      </div>
    </div>

    <!-- ===== Chat ===== -->
    <div class="chat-container" id="chatBox">
      <div class="chat-header">
        <img id="avatarImg" class="avatar" alt="Foto do atendente" title="Trocar foto" />
        <strong id="roleTitle">Atendimento</strong>
        <div class="timer" id="timer">‚è±Ô∏è 00:00</div>
        <span id="recBadge" class="rec-badge" aria-live="polite"><span class="dot" aria-hidden="true"></span> gravando‚Ä¶</span>
        <button id="toggleSound" class="btn-som" title="Ativar/desativar som">üîî</button>
      </div>

      <div class="chat-body" id="chatBody">
        <div class="center-row" id="centerRow">
          <div class="waiting-banner" id="waitingBanner">Consultor em atendimento, aguarde ser chamado...</div>
        </div>
      </div>

      <!-- Digitando estilo WhatsApp -->
      <div class="typing" id="typingHint" style="display:none">
        <span class="typing-bubble">
          <span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>
          <span class="typing-text">digitando‚Ä¶</span>
        </span>
      </div>

      <!-- Barra de resposta -->
      <div class="reply-bar" id="replyBar">
        <div>‚Ü©Ô∏è</div>
        <div class="excerpt" id="replyExcerpt"></div>
        <button class="reply-cancel" id="replyCancel" title="Cancelar resposta">‚úñ</button>
      </div>

      <div class="chat-footer">
        <button id="fileBtn" class="icon-btn secondary" title="Enviar foto/arquivo">üìé</button>
        <input type="file" id="fileInput" accept="image/*" hidden />
        <input type="file" id="avatarPicker" accept="image/*" hidden />
        <input type="text" id="msgInput" placeholder="Digite sua mensagem..." />
        <button id="actionBtn" class="mic" title="Gravar √°udio"><span class="ico" aria-hidden="true"></span></button>
        <div id="recBar" class="rec-bar" aria-live="polite">
          <button id="recTrash" class="rec-btn trash" title="Apagar">
            <span class="i i-trash" aria-hidden="true"></span>Apagar
          </button>
          <div class="rec-label" id="recLabel">üéôÔ∏è Gravando √°udio</div>
          <div class="rec-time" id="recTime">0:00</div>
          <div class="rec-meter" id="recMeter" aria-hidden="true">
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
            <span class="dot"></span><span class="dot"></span>
          </div>
          <button id="recPause" class="rec-btn pause" title="Pausar/Retomar">
            <span class="i i-pause" aria-hidden="true"></span>Pausar
          </button>
        </div>
      </div>

      <button id="endBtn">Encerrar conversa</button>
    </div>

    <div id="chat-ended">‚úÖ Conversa encerrada</div>
  </div>

  <!-- ===== Tarot ===== -->
  <div class="col tarot-col">
    <div id="lenRootWrap">
      <div id="lenRoot">
        <div class="layout">
          <main class="board" id="board" aria-label="Mesa de cartas"></main>
        </div>
      </div>
    </div>
    <div class="tarot-actions">
      <button class="btn-print" id="btnTarotPrint" aria-label="Enviar print das cartas">Enviar print das cartas</button>
      <button class="btn-shuffle" id="btnTarotShuffle" aria-label="Embaralhar cartas">Embaralhar cartas</button>
    </div>
  </div>
</div>

<!-- √Åudio -->
<audio id="sndSend" preload="auto" src="/sounds/notify.mp3"></audio>
<audio id="sndRecv" preload="auto" src="/sounds/notify.mp3"></audio>
<audio id="sndQueue" preload="auto" src="/sounds/bell.mp3"></audio>

<!-- libs -->
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* ===== Ajuste 100vh m√≥vel ===== */
function setVh(){ const vh = window.innerHeight * 0.01; document.documentElement.style.setProperty('--vh', `${vh}px`); }
setVh(); addEventListener('resize', setVh); addEventListener('orientationchange', setVh);

/* ===== IDENTIDADE POR ABA ===== */
const qs = new URLSearchParams(location.search);
const ROLE = (qs.get("role") || "cliente").toLowerCase();
const ROOM = (qs.get("room") || "main");
function genUID(){ if (crypto && crypto.randomUUID) return crypto.randomUUID(); return Date.now()+"-"+Math.random().toString(36).slice(2); } // (√∫nica defini√ß√£o)
if (!sessionStorage.getItem("UID")) sessionStorage.setItem("UID", genUID());
const UID = sessionStorage.getItem("UID");
document.body.setAttribute("data-role", ROLE);

/* ===== T√≠tulo ===== */
const rtEl = document.getElementById("roleTitle");
if (ROLE === "atendente"){ rtEl.textContent = ""; } else { rtEl.textContent = `Atendimento (Cliente) ‚Äî sala: ${ROOM}`; }

/* ===== AVATAR ===== */
const DEFAULT_AVATAR = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 96 96"><circle cx="48" cy="32" r="16" fill="%23cccccc"/><rect x="16" y="56" width="64" height="28" rx="14" fill="%23cccccc"/></svg>';
const AVATAR_KEY = `avatar:${ROOM}`;
const REMOTE_AVATAR_KEY = `remoteAvatar:${ROOM}`;
const avatarImg = document.getElementById('avatarImg');
const avatarPicker = document.getElementById('avatarPicker');

function setLocalAvatar(dataUrl){ try{ sessionStorage.setItem(AVATAR_KEY, dataUrl); }catch(_){} avatarImg.src = dataUrl; }
function setRemoteAvatar(dataUrl){ try{ sessionStorage.setItem(REMOTE_AVATAR_KEY, dataUrl); }catch(_){} avatarImg.src = dataUrl; }
function initAvatar(){
  avatarImg.src = DEFAULT_AVATAR;
  if (ROLE === 'atendente'){
    const saved = sessionStorage.getItem(AVATAR_KEY);
    if (saved) avatarImg.src = saved;
    avatarImg.addEventListener('click', ()=> avatarPicker.click());
    avatarPicker.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      if (!f.type.startsWith('image/')) return;
      const reader = new FileReader();
      reader.onload = async ()=>{
        const dataUrl = await downscaleDataUrl(reader.result, 256, 0.85); // WebP leve para avatar
        setLocalAvatar(dataUrl);
        if (isPaired) { try { socket.emit("chat_image", { dataUrl, alt: "__avatar__" }); } catch(_){} }
        avatarPicker.value = '';
      };
      reader.readAsDataURL(f);
    });
  } else {
    const remote = sessionStorage.getItem(REMOTE_AVATAR_KEY);
    if (remote) avatarImg.src = remote;
  }
}

/* ===== HIST√ìRICO LOCAL ===== */
const STORE_KEY = `history:${ROOM}:${ROLE}:${UID}`;
let history = []; let restored = false;
function saveHistory(){
  const saver = () => { try{ sessionStorage.setItem(STORE_KEY, JSON.stringify(history.slice(-200))); }catch(_){} };
  if (window.requestIdleCallback) requestIdleCallback(saver, { timeout: 500 });
  else setTimeout(saver, 0);
}
function restoreHistory(){
  try { history = JSON.parse(sessionStorage.getItem(STORE_KEY) || "[]"); } catch{ history = []; }
  history.forEach(h=>{
    if (h.t==="text") addMessage(h.text, h.sender, h.id, h.seen, h.reply || null);
    if (h.t==="img") addImageMessage(h.dataUrl, h.sender, h.alt||"Imagem", h.id, h.seen, h.reply || null);
    if (h.t==="aud") addAudioMessage(h.dataUrl, h.sender, h.dur||0, h.id, h.seen, h.reply || null);
  });
  restored = true;
}

/* ===== DOM ===== */
const chatBody = document.getElementById('chatBody');
const centerRow = document.getElementById('centerRow');
const waitingBanner = document.getElementById('waitingBanner');
const timerEl = document.getElementById('timer');
const msgInput = document.getElementById('msgInput');
const actionBtn = document.getElementById('actionBtn');
const recBadge = document.getElementById('recBadge');
let segundos = 0, cronometro = null, isPaired = false;

/* ===== Barra de grava√ß√£o DOM ===== */
const recBar   = document.getElementById('recBar');
const recTime  = document.getElementById('recTime');
const recMeter = document.getElementById('recMeter');
const recPauseBtn = document.getElementById('recPause');
const recTrashBtn = document.getElementById('recTrash');
const recLabel = document.getElementById('recLabel');
let recUITimer = null;
let recAnalyser = null, recAudioCtx = null, recSrcNode = null;
let recPaused = false;

/* ===== REPLY ===== */
let replyContext = null;
const replyBar = document.getElementById('replyBar');
const replyExcerpt = document.getElementById('replyExcerpt');
const replyCancel = document.getElementById('replyCancel');
replyCancel.addEventListener('click', clearReply);
function setReply(ctx){ replyContext = ctx; replyExcerpt.textContent = ctx.preview || ''; replyBar.style.display = 'flex'; }
function clearReply(){ replyContext = null; replyBar.style.display = 'none'; replyExcerpt.textContent = ''; }

/* ===== Persist√™ncia local do timer ===== */
const TIMER_KEY = `timer:${ROOM}`;
function saveTimerLocal(state){ try{ localStorage.setItem(TIMER_KEY, JSON.stringify(state)); }catch(_){} }
function loadTimerLocal(){ try{ return JSON.parse(localStorage.getItem(TIMER_KEY) || "{}"); }catch(_){ return {}; } }
function applyTimerLocalOnLoad(){ const st = loadTimerLocal(); if (Number.isFinite(st.pausedSec)){ segundos = Math.max(0, st.pausedSec|0); updateTimer(); } else { segundos = 0; updateTimer(); } }

/* ===== SOCKET ===== */
const socket = io({ transports: ["websocket", "polling"] });

socket.on("connect", () => {
  socket.emit("register", { role: ROLE, room: ROOM, name: ROLE === "cliente" ? "Cliente" : "Atendente", uid: UID });

  initAvatar();

  if (ROLE === "cliente") { centerRow.style.display = "flex"; setChatEnabled(false); }
  if (!restored) restoreHistory();

  applyTimerLocalOnLoad();

  requestAnimationFrame(scrollDown);
  updateActionBtnState();
});

socket.on("queue_size", ({ size }) => { const chip = document.getElementById("chipEspera"); if (chip) chip.textContent = String(size); });
socket.on("queue_join", () => { if (ROLE === "atendente") playSound("sndQueue"); });

socket.on("paired", () => {
  isPaired = true;
  avatarImg.classList.add('online');
  timerEl.classList.toggle('running', !!cronometro);
  centerRow.style.display = "none";
  setChatEnabled(true);
  if (ROLE === "cliente" && history.length === 0) {
    addMessage("Conectado ao atendente.", "client", genUID(), true);
    history.push({ t:"text", sender:"client", text:"Conectado ao atendente.", id: genUID(), seen: true }); saveHistory();
  }
  if (ROLE === 'atendente'){
    const av = sessionStorage.getItem(AVATAR_KEY);
    if (av) { try { socket.emit("chat_image", { dataUrl: av, alt: "__avatar__" }); } catch(_){} }
  }
  scrollDown(); updateActionBtnState();
});

/* ===== Exclus√£o ===== */
function addDeleteButton(container, id){
  if (!id) return;
  const btn = document.createElement('button');
  btn.className = 'del-btn'; btn.title = 'Apagar mensagem'; btn.textContent = 'üóëÔ∏è';
  btn.style.cssText = 'margin-left:6px;background:transparent;border:none;cursor:pointer;opacity:.7;';
  btn.addEventListener('click', ()=>{ removeMessageDom(id); removeFromHistory(id); try{ socket.emit("delete_message", { id }); }catch(_){ } });
  return btn;
}
function removeMessageDom(id){ const el = chatBody.querySelector(`.message[data-id="${id}"]`); if (el) el.remove(); }
function removeFromHistory(id){ const idx = history.findIndex(h => h.id === id); if (idx >= 0){ history.splice(idx,1); saveHistory(); } }

/* ===== REA√á√ïES ===== */
const REACT_KEY = `reactions:${ROOM}`;
let reactionsMap = {};
function loadReactions(){ try { reactionsMap = JSON.parse(sessionStorage.getItem(REACT_KEY) || "{}"); } catch { reactionsMap = {}; } }
function saveReactions(){ try { sessionStorage.setItem(REACT_KEY, JSON.stringify(reactionsMap)); } catch {} }
loadReactions();

const EMOJIS = ["üëç","‚ù§Ô∏è","üòÇ","üòÆ","üò¢","üôè"];

function toggleReactionLocal(msgId, emoji, uid){
  if (!reactionsMap[msgId]) reactionsMap[msgId] = {};
  if (!reactionsMap[msgId][emoji]) reactionsMap[msgId][emoji] = [];
  const arr = reactionsMap[msgId][emoji];
  const i = arr.indexOf(uid);
  if (i >= 0) arr.splice(i,1); else arr.push(uid);
  if (reactionsMap[msgId][emoji].length === 0) delete reactionsMap[msgId][emoji];
  if (Object.keys(reactionsMap[msgId]).length === 0) delete reactionsMap[msgId];
  saveReactions();
}

function renderReactionsRow(container, msgId){
  let row = container.querySelector('.reactions-row');
  if (!reactionsMap[msgId]) { if (row) row.remove(); return; }
  const entries = Object.entries(reactionsMap[msgId]).filter(([,uids])=>uids.length>0);
  if (entries.length === 0){ if (row) row.remove(); return; }
  if (!row){ row = document.createElement('div'); row.className = 'reactions-row'; container.appendChild(row); }
  row.innerHTML = "";
  entries.forEach(([emo,uids])=>{
    const pill = document.createElement('span'); pill.className = 'reaction-pill'; pill.textContent = `${emo} ${uids.length}`;
    row.appendChild(pill);
  });
}

/* ===== Picker de rea√ß√£o/responder ===== */
function openReactPicker(x, y, onPick){
  closeReactPicker();
  const picker = document.createElement('div'); picker.className='react-picker';
  EMOJIS.forEach(e=>{ const b=document.createElement('button'); b.type='button'; b.textContent=e; b.addEventListener('click', ()=>{ onPick(e); closeReactPicker(); }); picker.appendChild(b); });
  const sep=document.createElement('span'); sep.style.marginLeft='6px'; picker.appendChild(sep);
  const replyBtn=document.createElement('button'); replyBtn.type='button'; replyBtn.textContent='‚Ü©Ô∏è Responder'; replyBtn.className='reply-opt';
  replyBtn.addEventListener('click', ()=>{ onPick('__reply__'); closeReactPicker(); });
  picker.appendChild(replyBtn);
  document.body.appendChild(picker);
  const rect = picker.getBoundingClientRect();
  picker.style.left = Math.max(6, Math.min(x-rect.width/2, innerWidth-rect.width-6))+'px';
  picker.style.top  = Math.max(6, Math.min(y-rect.height-8, innerHeight-rect.height-6))+'px';
  setTimeout(()=>{ const off=(e)=>{ if(!picker.contains(e.target)) closeReactPicker(); }; document.addEventListener('pointerdown', off, {once:true}); },0);
}
function closeReactPicker(){ const el=document.querySelector('.react-picker'); if(el) el.remove(); }

function addLongPress(el, cb, ms=450){ let t=null; const start=(e)=>{ t=setTimeout(()=>cb(e),ms); }; const cancel=()=>{ if(t){clearTimeout(t); t=null;} }; el.addEventListener('pointerdown', start); el.addEventListener('pointerup', cancel); el.addEventListener('pointercancel', cancel); el.addEventListener('pointerleave', cancel); }

/* ===== helpers preview ===== */
function getBubblePreview(bubbleEl){
  const t=bubbleEl.querySelector('.text'); const img=bubbleEl.querySelector('.image img'); const aud=bubbleEl.querySelector('audio');
  if (t && t.textContent) return t.textContent.trim().slice(0,120);
  if (img) return 'üñºÔ∏è ' + (img.alt || 'Imagem');
  if (aud) return 'üé§ √Åudio';
  return '';
}

/* ===== lixeira / swipe / long press ===== */
function attachTapTrash(bubbleEl, msgId, isMine){
  if (!isMine) return;
  let trash=bubbleEl.querySelector('.trash-pop');
  if(!trash){
    trash=document.createElement('button'); trash.className='trash-pop'; trash.type='button'; trash.title='Apagar mensagem'; trash.textContent='üóëÔ∏è';
    trash.addEventListener('click',(e)=>{ e.stopPropagation(); removeMessageDom(msgId); removeFromHistory(msgId); try{ socket.emit("delete_message",{id:msgId}); }catch(_){ } });
    bubbleEl.appendChild(trash);
  }
  bubbleEl.addEventListener('click',(e)=>{
    if (e.target.closest('audio')||e.target.closest('button')) return;
    bubbleEl.classList.toggle('show-trash');
    const off=(ev)=>{ if(!bubbleEl.contains(ev.target)){ bubbleEl.classList.remove('show-trash'); document.removeEventListener('pointerdown', off, true); } };
    document.addEventListener('pointerdown', off, true);
  });
}

function attachSwipeToReply(bubbleEl, msgId){
  let startX=0,startY=0,dx=0,dy=0,dragging=false,activated=false,pointerId=null;
  const THRESH=52, MAX_ANGLE=28;
  const onDown=(e)=>{ if(e.target.closest('button')||e.target.closest('audio'))return; dragging=true; activated=false; dx=dy=0; startX=e.clientX; startY=e.clientY; pointerId=e.pointerId; try{ bubbleEl.setPointerCapture(pointerId);}catch(_){ }
    if(e.pointerType==='touch'){ try{ e.preventDefault(); }catch(_){} } bubbleEl.classList.add('dragging','swipe-hint'); };
  const onMove=(e)=>{ if(!dragging) return; dx=e.clientX-startX; dy=e.clientY-startY; if(dx<0) dx=0; const angle=Math.abs(Math.atan2(dy,dx)*180/Math.PI);
    if(dx>0 && angle<MAX_ANGLE){ bubbleEl.style.transform=`translateX(${Math.min(dx,THRESH)}px)`; if(dx>=THRESH && !activated){ activated=true; if(navigator.vibrate) try{ navigator.vibrate(8);}catch(_){ } } } };
  const onUp=()=>{ if(!dragging) return; dragging=false; try{ bubbleEl.releasePointerCapture(pointerId);}catch(_){}
    pointerId=null; bubbleEl.classList.remove('dragging','swipe-hint'); bubbleEl.style.transform=''; if(activated){ const preview=getBubblePreview(bubbleEl); if(preview){ setReply({id:msgId, preview}); msgInput.focus(); } } };
  bubbleEl.addEventListener('pointerdown', onDown, {passive:false}); bubbleEl.addEventListener('pointermove', onMove, {passive:true}); bubbleEl.addEventListener('pointerup', onUp); bubbleEl.addEventListener('pointercancel', onUp);
}

function attachLongPressOnBubble(bubbleEl, id){
  addLongPress(bubbleEl, (e)=>{
    const {clientX:x, clientY:y}=e;
    openReactPicker(x,y,(choice)=>{
      if(choice==='__reply__'){
        const preview=getBubblePreview(bubbleEl);
        if(preview){ setReply({ id, preview:preview.slice(0,120)}); msgInput.focus(); }
      } else {
        toggleReactionLocal(id, choice, UID);
        renderReactionsRow(bubbleEl, id);
        try{ socket.emit("message_reaction", { id, emoji: choice, uid: UID }); }catch(_){}
        try{ socket.emit("chat_image", { dataUrl: "data:application/json;base64,MA==", alt: `__reaction__|${id}|${choice}|${UID}` }); }catch(_){ }
      }
    });
  }, 450);
}

function attachLongPressAudio(targetWrap, id){
  addLongPress(targetWrap, (e)=>{
    const {clientX:x, clientY:y}=e;
    openReactPicker(x,y,(choice)=>{
      if(choice==='__reply__'){ setReply({ id, preview:'üé§ √Åudio' }); }
      else {
        toggleReactionLocal(id, choice, UID);
        renderReactionsRow(targetWrap.parentElement, id);
        try{ socket.emit("message_reaction", { id, emoji: choice, uid: UID }); }catch(_){}
        try{ socket.emit("chat_image", { dataUrl: "data:application/json;base64,MA==", alt: `__reaction__|${id}|${choice}|${UID}` }); }catch(_){ }
      }
    });
  });
}

/* ===== NOVO: clique em bal√£o RECEBIDO de TEXTO abre o picker de rea√ß√µes ===== */
function attachClickForReceived(bubbleEl, id){
  bubbleEl.addEventListener('click', (e)=>{
    if (bubbleEl.closest('.mine')) return;
    if (e.target.closest('button') || e.target.closest('audio')) return;

    const { clientX:x, clientY:y } = e;
    openReactPicker(x, y, (choice)=>{
      if (choice === '__reply__'){
        const preview = getBubblePreview(bubbleEl);
        if (preview){ setReply({ id, preview: preview.slice(0,120) }); }
      } else {
        toggleReactionLocal(id, choice, UID);
        renderReactionsRow(bubbleEl, id);
        try{ socket.emit("message_reaction", { id, emoji: choice, uid: UID }); }catch(_){}
        try{ socket.emit("chat_image", { dataUrl:"data:application/json;base64,MA==", alt:`__reaction__|${id}|${choice}|${UID}` }); }catch(_){ }
      }
    });
  });
}

/* ====== MENSAGENS ====== */
const mySide = (ROLE === "atendente") ? "attendant" : "client";
const pendingReplyMeta = {}; // id -> preview (chega via fallback)

function makeReplyNode(reply){
  if (!reply) return null;
  const q=document.createElement('div'); q.className='reply-quote'; q.textContent=reply.preview || ''; return q;
}
function ensureReplyFallback(id, reply){
  if (!reply && pendingReplyMeta[id]){
    reply = { id, preview: pendingReplyMeta[id] };
    delete pendingReplyMeta[id];
  }
  return reply;
}

function addMessage(text, sender, id = genUID(), seen = false, reply=null){
  reply = ensureReplyFallback(id, reply);
  const d=document.createElement('div'); d.classList.add('message', sender); d.dataset.id=id;
  const isMine=(sender===mySide); d.classList.add(isMine?'mine':'theirs');
  const bubble=document.createElement('div'); bubble.className='bubble';
  const q=makeReplyNode(reply); if(q) bubble.appendChild(q);
  const t=document.createElement('div'); t.classList.add('text'); t.textContent=text; bubble.appendChild(t);

  attachTapTrash(bubble,id,isMine);
  attachSwipeToReply(bubble,id);

  if (!isMine) attachClickForReceived(bubble, id);
  if (!isMine) attachLongPressOnBubble(bubble,id);

  d.appendChild(bubble);
  if(isMine){ const meta=document.createElement('div'); meta.className='meta'; const rc=document.createElement('span'); rc.className='receipt'+(seen?' seen':''); rc.id=`rcp-${id}`; rc.innerHTML='<span class="check">‚úì</span><span class="check">‚úì</span>'; meta.appendChild(rc); d.appendChild(meta); }
  chatBody.appendChild(d); renderReactionsRow(bubble, id); scrollDown();
}

function addImageMessage(dataUrl, sender, alt="Imagem", id = genUID(), seen=false, reply=null){
  reply = ensureReplyFallback(id, reply);
  const d=document.createElement('div'); d.classList.add('message', sender); d.dataset.id=id;
  const isMine=(sender===mySide); d.classList.add(isMine?'mine':'theirs');
  const bubble=document.createElement('div'); bubble.className='bubble';
  const q=makeReplyNode(reply); if(q) bubble.appendChild(q);
  const w=document.createElement('div'); w.className='image';
  const i=document.createElement('img'); i.src=dataUrl; i.alt=alt; i.loading="lazy"; i.decoding="async"; w.appendChild(i); bubble.appendChild(w);

  attachTapTrash(bubble,id,isMine);
  attachSwipeToReply(bubble,id);
  if (!isMine) {
    attachLongPressOnBubble(bubble,id);
    w.addEventListener('click', (e)=>{
      const {clientX:x, clientY:y}=e;
      openReactPicker(x,y,(choice)=>{
        if(choice==='__reply__'){
          setReply({ id, preview:'üñºÔ∏è ' + (i.alt||'Imagem') });
        } else {
          toggleReactionLocal(id, choice, UID);
          renderReactionsRow(bubble, id);
          try{ socket.emit("message_reaction", { id, emoji: choice, uid: UID }); }catch(_){}
          try{ socket.emit("chat_image", { dataUrl: "data:application/json;base64,MA==", alt: `__reaction__|${id}|${choice}|${UID}` }); }catch(_){}
        }
      });
    });
  }

  d.appendChild(bubble);
  if(isMine){ const meta=document.createElement('div'); meta.className='meta'; const rc=document.createElement('span'); rc.className='receipt'+(seen?' seen':''); rc.id=`rcp-${id}`; rc.innerHTML='<span class="check">‚úì</span><span class="check">‚úì</span>'; meta.appendChild(rc); d.appendChild(meta); }
  chatBody.appendChild(d); renderReactionsRow(bubble, id); scrollDown();
}

function addAudioMessage(dataUrl, sender, durSec=0, id = genUID(), seen=false, reply=null){
  reply = ensureReplyFallback(id, reply);
  const d=document.createElement('div'); d.classList.add('message', sender); d.dataset.id=id;
  const isMine=(sender===mySide); d.classList.add(isMine?'mine':'theirs');
  const bubble=document.createElement('div'); bubble.className='bubble';
  const q=makeReplyNode(reply); if(q) bubble.appendChild(q);
  const wrap=document.createElement('div'); wrap.className='audio-wrap';
  const audio=document.createElement('audio'); audio.controls=true; audio.preload="metadata"; audio.src=dataUrl; wrap.appendChild(audio);
  const tools=document.createElement('div'); tools.className='audio-toolbar';
  const backBtn=document.createElement('button'); backBtn.className='rewind-btn'; backBtn.type='button'; backBtn.textContent='‚è™ 5s'; backBtn.title='Voltar 5 segundos';
  backBtn.addEventListener('click', async (e)=>{ e.stopPropagation(); if(audio.readyState<1) await new Promise(r=>audio.addEventListener('loadedmetadata', r, {once:true})); try{ audio.currentTime=Math.max(0, audio.currentTime-5);}catch(_){} });
  tools.appendChild(backBtn); wrap.appendChild(tools);
  const dur=document.createElement('div'); dur.className='duration'; dur.textContent = durSec ? `‚è±Ô∏è ${String(Math.floor(durSec/60)).padStart(2,'0')}:${String(Math.floor(durSec%60)).padStart(2,'0')}` : '√Åudio';
  wrap.appendChild(dur);

  if (isMine){
    wrap.addEventListener('click',(e)=>{ if(e.target.closest('button')) return; if(audio.paused){ audio.play().catch(()=>{});} else { audio.pause(); } });
  } else {
    wrap.addEventListener('click',(e)=>{
      if (e.target.closest('button')) return;
      const {clientX:x, clientY:y}=e;
      openReactPicker(x,y,(choice)=>{
        if(choice==='__reply__'){ setReply({ id, preview:'üé§ √Åudio' }); }
        else {
          toggleReactionLocal(id, choice, UID);
          renderReactionsRow(bubble, id);
          try{ socket.emit("message_reaction", { id, emoji: choice, uid: UID }); }catch(_){}
          try{ socket.emit("chat_image", { dataUrl: "data:application/json;base64,MA==", alt: `__reaction__|${id}|${choice}|${UID}` }); }catch(_){ }
        }
      });
    });
  }

  bubble.appendChild(wrap);

  if (!isMine) attachLongPressAudio(wrap,id);
  attachTapTrash(bubble,id,isMine);
  attachSwipeToReply(bubble,id);
  if (!isMine) attachLongPressOnBubble(bubble,id);

  d.appendChild(bubble);
  if(isMine){ const meta=document.createElement('div'); meta.className='meta'; const rc=document.createElement('span'); rc.className='receipt'+(seen?' seen':''); rc.id=`rcp-${id}`; rc.innerHTML='<span class="check">‚úì</span><span class="check">‚úì</span>'; meta.appendChild(rc); d.appendChild(meta); }
  chatBody.appendChild(d); renderReactionsRow(bubble, id); scrollDown();

  if (!isMine){
    audio.addEventListener('ended', ()=>{ try{ socket.emit('audio_listened', { id }); }catch(_){ } });
  }
}

function markSeen(id){ const r=document.getElementById(`rcp-${id}`); if(r) r.classList.add('seen'); const idx=history.findIndex(h=>h.id===id); if(idx>=0){ history[idx].seen=true; saveHistory(); } }

/* ===== Recebimento ===== */
function shouldIgnoreInbound(){ return (ROLE === "cliente" && !isPaired); }

socket.on("chat_message", ({ from, text, id, reply }) => {
  if (shouldIgnoreInbound()) return;
  const s = from === "attendant" ? "attendant" : "client";
  addMessage(text, s, id, false, reply || null);
  history.push({ t:"text", sender:s, text, id, seen:false, reply: reply || null }); saveHistory();
  if (mySide !== s) {
    playSound("sndRecv");
    if (document.visibilityState === 'visible') { try { socket.emit("message_seen", { id }); } catch(_){} }
  }
});
socket.on("message_seen", ({ id }) => markSeen(id));

/* ===== chat_image: imagens e META (avatar/reaction/reply-fallback) ===== */
socket.on("chat_image", ({ from, dataUrl, alt, id, reply }) => {
  if (shouldIgnoreInbound()) return;

  if (alt === "__avatar__"){ setRemoteAvatar(dataUrl); return; }

  if (typeof alt === 'string' && alt.startsWith("__reaction__|")){
    const [, msgId, emoji, uid] = alt.split("|");
    if (uid === UID) return;
    const bubble = chatBody.querySelector(`.message[data-id="${msgId}"] .bubble`);
    if (bubble){
      toggleReactionLocal(msgId, emoji, uid);
      renderReactionsRow(bubble, msgId);
    }
    return;
  }

  if (typeof alt === 'string' && alt.startsWith("__reply__|")){
    const [, msgId, ...rest] = alt.split("|");
    const preview = decodeURIComponent(rest.join("|"));
    const holder = chatBody.querySelector(`.message[data-id="${msgId}"] .bubble`);
    if (holder){
      if (!holder.querySelector('.reply-quote')){
        const q=document.createElement('div'); q.className='reply-quote'; q.textContent=preview; holder.insertBefore(q, holder.firstChild);
      }
    } else {
      pendingReplyMeta[msgId] = preview;
    }
    return;
  }

  const s = from === "attendant" ? "attendant" : "client";
  const mid = id || genUID();
  addImageMessage(dataUrl, s, alt || "Imagem", mid, false, reply || null);
  history.push({ t:"img", sender:s, dataUrl, alt, id: mid, seen:false, reply: reply || null }); saveHistory();
  if (mySide !== s) playSound("sndRecv");
});

socket.on("chat_audio", ({ from, dataUrl, durSec=0, id, reply }) => {
  if (shouldIgnoreInbound()) return;
  const s = from === "attendant" ? "attendant" : "client";
  const mid = id || genUID();
  addAudioMessage(dataUrl, s, durSec, mid, false, reply || null);
  history.push({ t:"aud", sender:s, dataUrl, dur: durSec, id: mid, seen:false, reply: reply || null }); saveHistory();
  if (mySide !== s) playSound("sndRecv");
});

/* ===== Rea√ß√µes recebidas via evento normal ===== */
socket.on("message_reaction", ({ id, emoji, uid })=>{
  if (shouldIgnoreInbound()) return;
  if (uid === UID) return;
  const msg = chatBody.querySelector(`.message[data-id="${id}"] .bubble`);
  if (!msg) return;
  toggleReactionLocal(id, emoji, uid);
  renderReactionsRow(msg, id);
});

/* ===== Dele√ß√£o recebida ===== */
socket.on("delete_message", ({ id }) => {
  if (shouldIgnoreInbound()) return;
  if (!id) return;
  removeMessageDom(id);
  removeFromHistory(id);
  if (reactionsMap[id]) { delete reactionsMap[id]; saveReactions(); }
});

/* ===== Digitando (tempo real, sem infinito) ===== */
const typingHint = document.getElementById("typingHint");
let typingHideTimer = null;

/* NOVO: estado do outro lado gravando? controla texto da bolha */
let otherRecActive = false;
const typingTextNode = document.querySelector('#typingHint .typing-text');

function setTypingText(txt){ if (typingTextNode) typingTextNode.textContent = txt; }

function showTypingBubble(){
  typingHint.style.display = "block";
  scrollDown();
  clearTimeout(typingHideTimer);
  typingHideTimer = setTimeout(()=>{ typingHint.style.display="none"; }, 2000);
}
function hideTypingBubble(){
  typingHint.style.display = "none";
  clearTimeout(typingHideTimer);
  typingHideTimer = null;
}

msgInput.addEventListener("input", ()=>{
  if (ROLE === "cliente" && !isPaired) return;
  updateActionBtnState();
  socket.emit("typing", { isTyping: msgInput.value.trim().length > 0 });
  clearTimeout(window.__typingEmitTimer);
  window.__typingEmitTimer = setTimeout(()=>{ socket.emit("typing", { isTyping:false }); }, 1500);
});
msgInput.addEventListener("blur", ()=>{ socket.emit("typing", { isTyping:false }); });
msgInput.addEventListener("keydown", (e)=>{ if (e.key === "Enter"){ e.preventDefault(); if (msgInput.value.trim()) sendMessage(); } });

/* SUBSTITU√çDO: agora respeita prioridade da grava√ß√£o */
socket.on("typing", ({ from, isTyping }) => {
  if (shouldIgnoreInbound()) return;
  const isOther = ((from === "attendant" && ROLE === "cliente") || (from === "client" && ROLE === "atendente"));
  if (!isOther) return;

  if (otherRecActive){
    setTypingText('gravando √°udio‚Ä¶');
    showTypingBubble();
    return;
  }

  if (isTyping){
    setTypingText('digitando‚Ä¶');
    showTypingBubble();
  } else {
    hideTypingBubble();
  }
});

/* ===== Timer / Encerrar ===== */
socket.on("timer_state", ({ running, elapsedSec }) => {
  if (shouldIgnoreInbound()) return;
  segundos = elapsedSec || 0;
  if (running){ saveTimerLocal({ running:true, startTs: Date.now() - (segundos*1000), pausedSec:0 }); iniciarCronometro(true); }
  else { pararCronometro(true); saveTimerLocal({ running:false, startTs:0, pausedSec:segundos }); }
  updateTimer();
});

socket.on("conversation_ended", ({ reason }) => {
  clearInterval(cronometro); cronometro = null; segundos = 0; updateTimer();
  timerEl.classList.remove('running'); avatarImg.classList.remove('online');
  try{ localStorage.removeItem(TIMER_KEY); }catch(_){}
  showEnded(reason); clearHistory(); chatBody.innerHTML = "";
  try { socket.emit("queue_sync", { room: ROOM }); } catch(_){ }
  setRecBadge(false);
  if (ROLE === "cliente") {
    const END_URL = "https://atendimento2.onrender.com/encerrado.html?v=" + Date.now();
    const box=document.createElement('div'); box.style.cssText="text-align:center;padding:12px;"; box.innerHTML=`üîÅ Redirecionando para a avalia√ß√£o‚Ä¶<br><a href="${END_URL}" style="font-weight:700;" target="_top" rel="noopener">Ir agora</a>`;
    document.body.appendChild(box);
    setTimeout(()=>{ try{ window.location.replace(END_URL);}catch(_){ window.location.href=END_URL; } }, 800);
  }
});

/* ===== UI helpers ===== */
function updateTimer(){ const m=String(Math.floor(segundos/60)).padStart(2,'0'); const s=String(segundos%60).padStart(2,'0'); timerEl.textContent=`‚è±Ô∏è ${m}:${s}`; }
function iniciarCronometro(silent){ if (!cronometro){ const startTs=Date.now()-(segundos*1000); saveTimerLocal({running:true, startTs, pausedSec:0}); cronometro=setInterval(()=>{ segundos++; updateTimer(); },1000); timerEl.classList.add('running'); if(!silent) socket.emit("timer_start"); } }
function pararCronometro(silent){ clearInterval(cronometro); cronometro=null; saveTimerLocal({running:false, startTs:0, pausedSec:segundos}); timerEl.classList.remove('running'); if(!silent) socket.emit("timer_stop"); }
function scrollDown(){ chatBody.scrollTop = chatBody.scrollHeight; }

function setChatEnabled(enabled){
  const input=document.getElementById('msgInput');
  if (enabled){ input.removeAttribute('disabled'); actionBtn.disabled=false; }
  else { input.setAttribute('disabled','disabled'); actionBtn.disabled=true; }
  updateActionBtnState();
}

function showEnded(reason){
  const ended=document.getElementById("chat-ended");
  ended.textContent = reason==="attendant_left"?"‚ö†Ô∏è Atendente desconectou":(reason==="client_left"?"‚ö†Ô∏è Cliente desconectou":"‚úÖ Conversa encerrada");
  ended.style.display="block"; setTimeout(()=>{ ended.style.display="none"; },1500);
}
function clearHistory(){ try{ sessionStorage.removeItem(STORE_KEY); }catch(_){ } history=[]; }

/* ===== Sons ===== */
let soundEnabled=true, audioReady=false;
function unlockAudioOnce(){ if (audioReady) return; const tryUnlock=(id)=>{ const a=document.getElementById(id); if(!a) return; a.muted=true; a.play().then(()=>{ a.pause(); a.currentTime=0; a.muted=false; a.volume=1; audioReady=true; }).catch(()=>{}); }; tryUnlock("sndSend"); tryUnlock("sndRecv"); tryUnlock("sndQueue"); }
window.addEventListener("pointerdown", unlockAudioOnce, { once:true });
function playSound(id){ if(!soundEnabled) return; const a=document.getElementById(id); if(a){ try{ a.currentTime=0; a.play(); }catch(_){} } }
const toggleBtn=document.getElementById("toggleSound"); if(toggleBtn){ toggleBtn.addEventListener("click", ()=>{ soundEnabled=!soundEnabled; toggleBtn.classList.toggle("off", !soundEnabled); toggleBtn.textContent = soundEnabled ? "üîî" : "üîï"; unlockAudioOnce(); }); }

/* ===== Envio (inclui reply) ===== */
function sendMessage(){
  if (ROLE === "cliente" && !isPaired) return;
  const msg = msgInput.value.trim(); if (!msg) return;
  const id = genUID();
  const reply = replyContext ? { id: replyContext.id, preview: replyContext.preview } : null;

  addMessage(msg, mySide, id, false, reply);
  history.push({ t:"text", sender: mySide, text: msg, id, seen:false, reply }); saveHistory();

  socket.emit("chat_message", { text: msg, id, reply });
  socket.emit("typing", { isTyping:false });

  if (reply && reply.preview){
    try{
      const alt = `__reply__|${id}|${encodeURIComponent(reply.preview)}`;
      socket.emit("chat_image", { dataUrl:"data:application/json;base64,MA==", alt, id });
    }catch(_){ }
  }

  playSound("sndSend");
  msgInput.value = ""; clearReply(); updateActionBtnState(); hideTypingBubble(); scrollDown();
}

/* ===== Estado do FAB ===== */
function updateActionBtnState(){
  const hasText = msgInput.value.trim().length > 0;
  const btn = actionBtn;

  if (isRecording()){
    btn.classList.add('send');
    btn.classList.remove('mic');
    btn.title = 'Enviar √°udio';
    return;
  }
  if (hasText){
    btn.classList.add('send'); btn.classList.remove('mic');
    btn.title='Enviar mensagem';
  }else{
    btn.classList.add('mic'); btn.classList.remove('send');
    btn.title='Gravar √°udio';
  }
}

/* ===== IMAGEM: presets por rede + WebP ===== */
function getNetPreset(){
  const et = (navigator.connection && navigator.connection.effectiveType) || '';
  if (/2g|3g/i.test(et)) return { w: 640, q: 0.75 };
  return { w: 720, q: 0.82 };
}

/* ===== Uploader de imagem ===== */
const fileBtn=document.getElementById('fileBtn'); const fileInput=document.getElementById('fileInput');
if(fileBtn && fileInput){
  fileBtn.addEventListener('click', ()=>{ if (ROLE === "cliente" && !isPaired) return; fileInput.click(); });
  fileInput.addEventListener('change', async (e)=>{
    const f=e.target.files && e.target.files[0]; if(!f) return;
    if (!f.type.startsWith('image/')){ addMessage("Apenas imagens s√£o suportadas aqui.", mySide); return; }
    const reader=new FileReader();
    reader.onload = async ()=>{
      const { w, q } = getNetPreset();
      const dataUrl = await downscaleDataUrl(reader.result, w, q); // WebP leve conforme rede

      const id=genUID();
      const reply = replyContext ? { id: replyContext.id, preview: replyContext.preview } : null;

      // salva THUMB no hist√≥rico (320px) para n√£o pesar o sessionStorage
      const thumb = await downscaleDataUrl(dataUrl, 320, Math.min(0.8, q));

      addImageMessage(thumb, mySide, f.name||"Imagem", id, false, reply);
      history.push({ t:"img", sender: mySide, dataUrl: thumb, alt:f.name||"Imagem", id, seen:false, reply }); saveHistory();

      // envia a vers√£o maior (ainda leve) pelo socket
      socket.emit("chat_image", { dataUrl, alt:f.name||"Imagem", id, reply });

      if (reply && reply.preview){
        try{ socket.emit("chat_image", { dataUrl:"data:application/json;base64,MA==", alt:`__reply__|${id}|${encodeURIComponent(reply.preview)}`, id }); }catch(_){}
      }

      playSound("sndSend"); fileInput.value=""; clearReply();
    };
    reader.readAsDataURL(f);
  });
}

/* ===== √ÅUDIO ===== */
let mediaRecorder=null, recChunks=[], recStartTs=0, recStopTimer=null, activeStream=null;
let wavRecorder=null;

function pickBestAudioMime(){
  const tries=['audio/mp4;codecs=mp4a.40.2','audio/mp4','audio/webm;codecs=opus','audio/ogg;codecs=opus','audio/webm','audio/ogg'];
  if(!window.MediaRecorder || !MediaRecorder.isTypeSupported) return '';
  return tries.find(t=>MediaRecorder.isTypeSupported(t)) || '';
}
function isRecording(){ return (mediaRecorder && mediaRecorder.state==='recording') || (wavRecorder && wavRecorder.recording); }

/* ===== UI rec bar helpers ===== */
function showRecBar(){
  recBar.classList.add('show');
  recLabel.style.display = 'none';
  recTime.textContent = '0:00';
  startMeterAnimation();
}
function hideRecBar(){
  recBar.classList.remove('show');
  stopMeterAnimation();
}
function fmtSec(s){ const m=Math.floor(s/60), r=s%60; return `${m}:${String(r).padStart(2,'0')}`; }
function startMeterAnimation(){
  if (!recAnalyser){
    const dots = recMeter.querySelectorAll('.dot');
    let t=0;
    recUITimer = setInterval(()=>{ t+=1; dots.forEach((d,i)=>{ const p=(Math.sin((t+i)/2)+1)/2; d.style.transform=`scale(${0.6 + p*0.8})`; d.style.opacity=String(0.5 + p*0.5); }); }, 80);
  }else{
    const data = new Uint8Array(recAnalyser.frequencyBinCount);
    const dots = recMeter.querySelectorAll('.dot');
    recUITimer = setInterval(()=>{
      recAnalyser.getByteTimeDomainData(data);
      let sum=0;
      for(let i=0;i<data.length;i++){ const v=(data[i]-128)/128; sum+=v*v; }
      const rms=Math.sqrt(sum/data.length);
      const level = Math.min(1, rms*1.8);
      dots.forEach((d,i)=>{ const f = Math.max(0.5, level + (i%3)*0.05); d.style.transform=`scale(${0.6 + f})`; d.style.opacity=String(0.6 + f*0.4); });
    }, 60);
  }
}
function stopMeterAnimation(){ if(recUITimer){ clearInterval(recUITimer); recUITimer=null; } }

/* ===== Badge (aparece para ambos) ===== */
function setRecBadge(on){
  if (!recBadge) return;
  recBadge.classList.toggle('show', !!on);
}

/* ===== startRecording (com barra & bot√£o verde = Enviar) ===== */
async function startRecording(){
  if (ROLE === "cliente" && !isPaired) return;
  try{
    const constraints={ audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true, channelCount:1 } };
    const stream=await navigator.mediaDevices.getUserMedia(constraints); activeStream=stream;

    try{
      const AC = window.AudioContext || window.webkitAudioContext;
      recAudioCtx = new AC();
      recSrcNode  = recAudioCtx.createMediaStreamSource(stream);
      recAnalyser = recAudioCtx.createAnalyser();
      recAnalyser.fftSize = 1024;
      recSrcNode.connect(recAnalyser);
    }catch(_){ recAnalyser=null; }

    const useMR=!!window.MediaRecorder; const mime=pickBestAudioMime();
    if(useMR){
      try{
        mediaRecorder=new MediaRecorder(stream, mime?{mimeType:mime}:undefined);
        recChunks=[]; recStartTs=Date.now();
        mediaRecorder.ondataavailable=(ev)=>{ if(ev.data && ev.data.size) recChunks.push(ev.data); };
        mediaRecorder.onstop=onMediaRecorderStop;
        mediaRecorder.start(200);
      }catch(err){ await startWavFallback(stream); }
    }else{
      await startWavFallback(stream);
    }

    showRecBar();
    recPaused=false;
    actionBtn.classList.add('send'); actionBtn.classList.remove('mic');
    actionBtn.title = 'Enviar √°udio';
    updateActionBtnState();

    setRecBadge(true);
    try{ socket.emit("rec_state", { state:"start", from: mySide }); }catch(_){}

    const t0 = Date.now();
    const tick = ()=>{ const secs = Math.max(0, Math.round((Date.now()-t0)/1000)); recTime.textContent = fmtSec(secs); };
    if (window.__recTimeInt) clearInterval(window.__recTimeInt);
    window.__recTimeInt = setInterval(tick, 250);

    recStopTimer=setTimeout(()=>{ if(isRecording()) stopRecording(); }, 60000);

  }catch(err){
    console.error(err);
    addMessage("Permita acesso ao microfone para enviar √°udio.", mySide);
  }
}

function stopRecording(){
  try{
    if(mediaRecorder && mediaRecorder.state==='recording'){ mediaRecorder.stop(); }
    else if(wavRecorder && wavRecorder.recording){ wavRecorder.stop().then(({blob, durSec})=>handleAudioBlob(blob, durSec)); }
  }catch(_){}
}

function onMediaRecorderStop(){
  clearTimeout(recStopTimer); recStopTimer=null;
  const durSec=Math.max(1, Math.round((Date.now()-recStartTs)/1000));
  const blobType=(mediaRecorder && mediaRecorder.mimeType)? mediaRecorder.mimeType : (recChunks[0] && recChunks[0].type) || 'audio/mp4';
  const blob=new Blob(recChunks,{type:blobType}); handleAudioBlob(blob, durSec);
}

function handleAudioBlob(blob, durSec){
  const fr=new FileReader();
  fr.onload=()=>{
    const dataUrl=fr.result; const id=genUID();
    const reply = replyContext ? { id: replyContext.id, preview: replyContext.preview } : null;

    addAudioMessage(dataUrl, mySide, durSec, id, false, reply);
    history.push({ t:"aud", sender: mySide, dataUrl, dur:durSec, id, seen:false, reply }); saveHistory();

    socket.emit("chat_audio", { dataUrl, durSec, id, reply });

    if (reply && reply.preview){
      try{ socket.emit("chat_image", { dataUrl:"data:application/json;base64,MA==", alt:`__reply__|${id}|${encodeURIComponent(reply.preview)}`, id }); }catch(_){ }
    }

    playSound("sndSend"); clearReply();
  };
  fr.readAsDataURL(blob);

  if(activeStream){ try{ activeStream.getTracks().forEach(t=>t.stop()); }catch(_){} }
  activeStream=null; mediaRecorder=null; wavRecorder=null;

  updateActionBtnState();
  hideRecBar(); recPaused=false;

  setRecBadge(false);
  try{ socket.emit("rec_state", { state:"stop", from: mySide }); }catch(_){}

  try{ if(recAudioCtx){ recAudioCtx.close(); } }catch(_){}
  recAudioCtx=null; recSrcNode=null; recAnalyser=null;

  if (window.__recTimeInt){ clearInterval(window.__recTimeInt); window.__recTimeInt=null; }
}

async function startWavFallback(stream){
  wavRecorder=new WavFallbackRecorder(stream); await wavRecorder.start();
}
class WavFallbackRecorder{
  constructor(stream){ this.stream=stream; this.ctx=null; this.source=null; this.processor=null; this.buffers=[]; this.recording=false; this.startTs=0; }
  async start(){ const AC=window.AudioContext||window.webkitAudioContext; this.ctx=new AC(); this.source=this.ctx.createMediaStreamSource(this.stream); const bufferSize=4096; this.processor=this.ctx.createScriptProcessor(bufferSize,1,1); this.source.connect(this.processor); this.processor.connect(this.ctx.destination); this.processor.onaudioprocess=(e)=>{ if(!this.recording) return; const ch0=e.inputBuffer.getChannelData(0); this.buffers.push(new Float32Array(ch0)); }; this.recording=true; this.startTs=Date.now(); }
  async stop(){ this.recording=false; try{ this.processor.disconnect(); }catch(_){ } try{ this.source.disconnect(); }catch(_){ } try{ await this.ctx.close(); }catch(_){ } try{ this.stream.getTracks().forEach(t=>t.stop()); }catch(_){ }
    const len=this.buffers.reduce((a,b)=>a+b.length,0); const data=new Float32Array(len); let off=0; for(const b of this.buffers){ data.set(b, off); off+=b.length; }
    const wavBlob=floatToWavBlob(data,1,44100); const durSec=Math.max(1, Math.round((Date.now()-this.startTs)/1000)); return { blob:wavBlob, durSec }; }
}
function floatToWavBlob(float32,numChannels,sampleRate){
  const bytesPerSample=2, blockAlign=numChannels*bytesPerSample, buffer=new ArrayBuffer(44+float32.length*bytesPerSample), view=new DataView(buffer);
  writeString(view,0,'RIFF'); view.setUint32(4,36+float32.length*bytesPerSample,true); writeString(view,8,'WAVE'); writeString(view,12,'fmt '); view.setUint32(16,16,true); view.setUint16(20,1,true); view.setUint16(22,numChannels,true); view.setUint32(24,sampleRate,true); view.setUint32(28,sampleRate*blockAlign,true); view.setUint16(32,blockAlign,true); view.setUint16(34,8*bytesPerSample,true); writeString(view,36,'data'); view.setUint32(40,float32.length*bytesPerSample,true);
  let offset=44; for(let i=0;i<float32.length;i++){ let s=Math.max(-1, Math.min(1, float32[i])); view.setInt16(offset, s<0 ? s*0x8000 : s*0x7FFF, true); offset+=2; }
  return new Blob([view],{type:'audio/wav'});
}
function writeString(view,offset,str){ for(let i=0;i<str.length;i++){ view.setUint8(offset+i, str.charCodeAt(i)); } }

/* ===== Controles da barra de grava√ß√£o ===== */
recPauseBtn.addEventListener('click', ()=>{
  if (!isRecording() && !recPaused) return;
  if (mediaRecorder && 'pause' in mediaRecorder){
    if (!recPaused){
      mediaRecorder.pause(); recPaused=true;
      recPauseBtn.textContent='Retomar';
      try{ socket.emit("rec_state", { state:"pause", from: mySide }); }catch(_){}
    } else {
      mediaRecorder.resume(); recPaused=false;
      recPauseBtn.innerHTML='<span class="i i-pause" aria-hidden="true"></span>Pausar';
      try{ socket.emit("rec_state", { state:"resume", from: mySide }); }catch(_){}
    }
  }else{
    alert('Pausar n√£o √© suportado neste dispositivo.');
  }
});

recTrashBtn.addEventListener('click', ()=>{
  try{
    clearTimeout(recStopTimer); recStopTimer=null;
    recChunks=[];
    if (mediaRecorder && mediaRecorder.state!=='inactive'){ mediaRecorder.stop(); }
    if (wavRecorder && wavRecorder.recording){ wavRecorder.stop().then(()=>{}); }
  }catch(_){}
  if(activeStream){ try{ activeStream.getTracks().forEach(t=>t.stop()); }catch(_){} }
  activeStream=null; mediaRecorder=null; wavRecorder=null;
  updateActionBtnState();
  hideRecBar(); recPaused=false;
  try{ if(recAudioCtx){ recAudioCtx.close(); } }catch(_){}
  recAudioCtx=null; recSrcNode=null; recAnalyser=null;
  if (window.__recTimeInt){ clearInterval(window.__recTimeInt); window.__recTimeInt=null; }
  setRecBadge(false);
  try{ socket.emit("rec_state", { state:"stop", from: mySide }); }catch(_){}
});

/* ===== Clique do FAB ===== */
actionBtn.addEventListener('pointerdown', unlockAudioOnce, { once:true });
actionBtn.addEventListener('click', ()=>{
  if (ROLE === "cliente" && !isPaired) return;
  const hasText=msgInput.value.trim().length>0;
  if(isRecording()){ stopRecording(); return; }  // envia √°udio
  if(hasText) sendMessage(); else startRecording();
});

/* ===== Rec badge recebido do outro lado ===== */
socket.on("rec_state", ({ state, from })=>{
  if (shouldIgnoreInbound()) return;
  const isOther = ((from === "attendant" && ROLE === "cliente") || (from === "client" && ROLE === "atendente"));
  if (!isOther) return;

  if (state === "start" || state === "resume" || state === "pause"){
    otherRecActive = true;
    setRecBadge(true);
    setTypingText('gravando √°udio‚Ä¶');
    showTypingBubble();
  } else {
    otherRecActive = false;
    setRecBadge(false);
    hideTypingBubble();
  }
});

/* NOVO: quando destinat√°rio ouvir at√© o fim, o remetente pinta o bal√£o */
socket.on('audio_listened', ({ id })=>{
  const msg = document.querySelector(`.message[data-id="${id}"]`);
  if (!msg || !msg.classList.contains('mine')) return;
  const bubble = msg.querySelector('.bubble');
  if (bubble) bubble.classList.add('audio-heard');
  const meta = msg.querySelector('.meta');
  if (meta && !meta.querySelector('.heard-flag')){
    const f = document.createElement('span'); f.className='heard-flag'; f.textContent='√°udio escutado';
    meta.appendChild(f);
  }
});

/* ===== Controles do atendente ===== */
const btnProximo=document.getElementById("btnProximo");
const btnTimer=document.getElementById("btnTimer");
const endBtn=document.getElementById("endBtn");
if (ROLE !== "atendente"){ btnProximo.style.display="none"; btnTimer.style.display="none"; }
btnProximo.addEventListener("click", ()=> socket.emit("next_in_queue"));
btnTimer.addEventListener("click", ()=>{ if(cronometro){ pararCronometro(); btnTimer.innerHTML='<span class="dot"></span> Iniciar tempo'; btnTimer.classList.remove("stop"); } else { iniciarCronometro(); btnTimer.innerHTML='<span class="dot"></span> Parar tempo'; btnTimer.classList.add("stop"); } });
endBtn.addEventListener("click", ()=> socket.emit("end_conversation"));

/* ===== TAROT ===== */
const DECK = [
  {n:0, nome:"O Louco", img:'cards/o-louco.jpg'},
  {n:1, nome:"O Mago", img:'cards/o-mago.jpg'},
  {n:2, nome:"A Sacerdotisa", img:'cards/a-sacerdotisa.jpg'},
  {n:3, nome:"A Imperatriz", img:'cards/a-imperatriz.jpg'},
  {n:4, nome:"O Imperador", img:'cards/o-imperador.jpg'},
  {n:5, nome:"O Papa", img:'cards/o-papa.jpg'},
  {n:6, nome:"Os Enamorados", img:'cards/os-enamorados.jpg'},
  {n:7, nome:"O Carro", img:'cards/o-carro.jpg'},
  {n:8, nome:"A For√ßa", img:'cards/a-forca.jpg'},
  {n:9, nome:"O Eremita", img:'cards/o-eremita.jpg'},
  {n:10, nome:"A Roda da Fortuna", img:'cards/a-roda-da-fortuna.jpg'},
  {n:11, nome:"A Justi√ßa", img:'cards/a-justica.jpg'},
  {n:12, nome:"O Enforcado", img:'cards/o-enforcado.jpg'},
  {n:13, nome:"A Morte", img:'cards/a-morte.jpg'},
  {n:14, nome:"A Temperan√ßa", img:'cards/a-temperanca.jpg'},
  {n:15, nome:"O Diabo", img:'cards/o-diabo.jpg'},
  {n:16, nome:"A Torre", img:'cards/a-torre.jpg'},
  {n:17, nome:"A Estrela", img:'cards/a-estrela.jpg'},
  {n:18, nome:"A Lua", img:'cards/a-lua.jpg'},
  {n:19, nome:"O Sol", img:'cards/o-sol.jpg'},
  {n:20, nome:"O Julgamento", img:'cards/o-julgamento.jpg'},
  {n:21, nome:"O Mundo", img:'cards/o-mundo.jpg'},

  // ==== ARCANOS MENORES ====
  {nome:"√Ås de Copas", img:'cards/01aceofcups_250.jpg'},
  {nome:"√Ås de Ouros", img:'cards/01aceofpentacles_250.jpg'},
  {nome:"√Ås de Espadas", img:'cards/01aceofswords_250.jpg'},
  {nome:"√Ås de Paus", img:'cards/as de paus.jpg'},

  {nome:"Dois de Copas", img:'cards/02ofcups_250.jpg'},
  {nome:"Dois de Ouros", img:'cards/02ofpentacles_250.jpg'},
  {nome:"Dois de Espadas", img:'cards/02ofswords_250.jpg'},
  {nome:"Dois de Paus", img:'cards/02ofwands_250.jpg'},

  {nome:"Tr√™s de Copas", img:'cards/03ofcups_250.jpg'},
  {nome:"Tr√™s de Ouros", img:'cards/03ofpentacles_250.jpg'},
  {nome:"Tr√™s de Espadas", img:'cards/03ofswords_250.jpg'},
  {nome:"Tr√™s de Paus", img:'cards/03ofwands_250.jpg'},

  {nome:"Quatro de Copas", img:'cards/04ofcups_250.jpg'},
  {nome:"Quatro de Ouros", img:'cards/04ofpentacles_250.jpg'},
  {nome:"Quatro de Espadas", img:'cards/04ofswords_250.jpg'},
  {nome:"Quatro de Paus", img:'cards/04ofwands_250.jpg'},

  {nome:"Cinco de Copas", img:'cards/05ofcups_250.jpg'},
  {nome:"Cinco de Ouros", img:'cards/05ofpentacles_250.jpg'},
  {nome:"Cinco de Espadas", img:'cards/05ofswords_250.jpg'},
  {nome:"Cinco de Paus", img:'cards/05ofwands_250.jpg'},

  {nome:"Seis de Copas", img:'cards/06ofcups_250.jpg'},
  {nome:"Seis de Ouros", img:'cards/06ofpentacles_250.jpg'},
  {nome:"Seis de Espadas", img:'cards/06ofswords_250.jpg'},
  {nome:"Seis de Paus", img:'cards/06ofwands_250.jpg'},

  {nome:"Sete de Copas", img:'cards/07ofcups_250.jpg'},
  {nome:"Sete de Ouros", img:'cards/07ofpentacles_250.jpg'},
  {nome:"Sete de Espadas", img:'cards/07ofswords_250.jpg'},
  {nome:"Sete de Paus", img:'cards/07ofwands_250.jpg'},

  {nome:"Oito de Copas", img:'cards/08ofcups_250.jpg'},
  {nome:"Oito de Ouros", img:'cards/08ofpentacles_250.jpg'},
  {nome:"Oito de Espadas", img:'cards/08ofswords_250.jpg'},
  {nome:"Oito de Paus", img:'cards/08ofwands_250.jpg'},

  {nome:"Nove de Copas", img:'cards/09ofcups_250.jpg'},
  {nome:"Nove de Ouros", img:'cards/09ofpentacles_250.jpg'},
  {nome:"Nove de Espadas", img:'cards/09ofswords_250.jpg'},
  {nome:"Nove de Paus", img:'cards/09ofwands_250.jpg'},

  {nome:"Dez de Copas", img:'cards/10ofcups_250.jpg'},
  {nome:"Dez de Ouros", img:'cards/10ofpentacles_250.jpg'},
  {nome:"Dez de Espadas", img:'cards/10ofswords_250.jpg'},
  {nome:"Dez de Paus", img:'cards/10ofwands_250.jpg'},

  {nome:"Valete de Copas", img:'cards/11pageofcups_250.jpg'},
  {nome:"Valete de Ouros", img:'cards/11pageofpentacles_250.jpg'},
  {nome:"Valete de Espadas", img:'cards/11pageofswords_250.jpg'},
  {nome:"Valete de Paus", img:'cards/11pageofwands_250.jpg'},

  {nome:"Cavaleiro de Copas", img:'cards/12knightofcups_250.jpg'},
  {nome:"Cavaleiro de Ouros", img:'cards/12knightofpentacles_250.jpg'},
  {nome:"Cavaleiro de Espadas", img:'cards/12knightofswords_250.jpg'},
  {nome:"Cavaleiro de Paus", img:'cards/12knightofwands_250.jpg'},

  {nome:"Rainha de Copas", img:'cards/13queenofcups_250.jpg'},
  {nome:"Rainha de Ouros", img:'cards/13queenofpentacles_250.jpg'},
  {nome:"Rainha de Espadas", img:'cards/13queenofswords_250.jpg'},
  {nome:"Rainha de Paus", img:'cards/13queenofwands_250.jpg'},

  {nome:"Rei de Copas", img:'cards/14kingofcups_250.jpg'},
  {nome:"Rei de Ouros", img:'cards/14kingofpentacles_250.jpg'},
  {nome:"Rei de Espadas", img:'cards/14kingofswords_250.jpg'},
  {nome:"Rei de Paus", img:'cards/14kingofwands_250.jpg'},
];

const board=document.getElementById("board");
let selecionadas=[];

function cryptoRandomInt(maxExclusive){ const c=window.crypto||window.msCrypto; if(!c) return Math.floor(Math.random()*maxExclusive); const a=new Uint32Array(1); c.getRandomValues(a); return a[0]%maxExclusive; }
function shuffleCrypto(arr){ for(let i=arr.length-1;i>0;i--){ const j=cryptoRandomInt(i+1); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
function sortear(n){ const idx=Array.from(DECK.keys()); shuffleCrypto(idx); return idx.slice(0,n); }

function montarCarta(deckIndex){
  const data=DECK[deckIndex];
  const slot=document.createElement("div"); slot.className="slot";
  const card=document.createElement("div"); card.className="card"; card.tabIndex=0;
  const back=document.createElement("div"); back.className="face back";
  const backImg=document.createElement("img"); backImg.src="cards/back.png"; backImg.alt="Verso"; backImg.decoding="async"; backImg.loading="eager"; backImg.style.width="100%"; backImg.style.height="100%"; backImg.style.objectFit="cover"; back.appendChild(backImg);
  const front=document.createElement("div"); front.className="face front";
  const img=document.createElement("img"); img.alt=data.nome; img.src=data.img; img.style.width="100%"; img.style.height="100%"; img.style.objectFit="cover"; front.appendChild(img);
  const flip=()=>{ card.classList.toggle("flipped"); };
  card.addEventListener("click", flip);
  card.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); flip(); } });
  card.appendChild(back); card.appendChild(front); slot.appendChild(card); return slot;
}
function renderBoard(){ board.innerHTML=""; selecionadas.forEach((i)=> board.appendChild(montarCarta(i))); }

/* === NOVO: 6 no celular, 8 no tablet, 6 no PC === */
function getDesiredCardCount(){
  const w = window.innerWidth;
  if (w <= 767) return 6;        // celular
  if (w <= 1024) return 8;       // tablet
  return 6;                      // pc
}
function ensureCardCount(){
  const desired = getDesiredCardCount();
  if (selecionadas.length !== desired){
    selecionadas = sortear(desired);
    renderBoard();
  }
}

/* inicia respeitando 6/8/6 e acompanha resize/orientation */
(function initTarot(){
  selecionadas = sortear(getDesiredCardCount());
  renderBoard();
  addEventListener('resize', ensureCardCount);
  addEventListener('orientationchange', ensureCardCount);
})();

/* ===== PRINT ===== */
const TARGET_WIDTH=320;
async function downscaleDataUrl(dataUrl, targetW=TARGET_WIDTH){
  return new Promise((resolve)=>{ const img=new Image(); img.onload=()=>{ const ratio=Math.min(targetW/img.width,1); const canvas=document.createElement('canvas'); canvas.width=Math.round(img.width*ratio); canvas.height=Math.round(img.height*ratio); canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height); resolve(canvas.toDataURL('image/png')); }; img.src=dataUrl; });
}
document.getElementById("btnTarotPrint").addEventListener("click", async ()=>{
  const target=document.querySelector("#lenRoot");
  try{
    const canvas=await html2canvas(target,{ backgroundColor:null, scale:1 });
    const raw=canvas.toDataURL("image/png");
    const thumb=await downscaleDataUrl(raw, TARGET_WIDTH);
    const id=genUID();
    addImageMessage(thumb, ROLE==="atendente"?"attendant":"client", "Leitura de Tarot", id, false);
    history.push({ t:"img", sender: ROLE==="atendente"?"attendant":"client", dataUrl: thumb, alt:"Leitura de Tarot", id, seen:false }); saveHistory();
    socket.emit("chat_image", { dataUrl: thumb, alt:"Leitura de Tarot", id });
  }catch(err){
    console.error("Falha ao gerar print:", err);
    addMessage("N√£o foi poss√≠vel gerar o print das cartas neste momento.", ROLE==="atendente"?"attendant":"client");
    history.push({ t:"text", sender: ROLE==="atendente"?"attendant":"client", text:"N√£o foi poss√≠vel gerar o print das cartas neste momento." }); saveHistory();
  }
});

/* ===== embaralhar respeitando 6/8/6 ===== */
document.getElementById("btnTarotShuffle").addEventListener("click", ()=>{
  selecionadas=sortear(getDesiredCardCount());
  renderBoard();
});

/* ===== Sair da fila ao fechar (cliente) ===== */
function notifyLeavingQueue(){
  try{
    if (ROLE === "cliente" && !isPaired) {
      socket.emit("leave_queue", { uid: UID, room: ROOM });
      socket.emit("queue_sync", { room: ROOM });
    }
  }catch(e){}
}
addEventListener("beforeunload", notifyLeavingQueue);
addEventListener("pagehide", notifyLeavingQueue);

function genUID(){ if (crypto && crypto.randomUUID) return crypto.randomUUID(); return Date.now()+"-"+Math.random().toString(36).slice(2); }
</script>
</body>
</html>
